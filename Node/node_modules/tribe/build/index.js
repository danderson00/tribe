var repository = require('tribe/build/steps'),
    blocks = require('tribe/build/blocks'),
    templates = require('tribe/build/templates'),
    utils = require('tribe/utilities'),
    Q = require('q'),
    _ = require('underscore'),
    steps,
    phases;

module.exports = {
    configure: function (newSteps, newPhases) {
        steps = _.map(newSteps, repository.create);
        phases = newPhases;
    },

    execute: function (context) {
        context = context || {};

        return _.reduce(phases, function (lastPhase, phase) {
            return Q.when(lastPhase).then(function () {
                return _.reduce(steps, function (lastStep, step) {
                    return Q.when(lastStep).then(function () {
                        return step[phase] && step[phase](context);
                    });
                }, null);
            });
        }, null).fail(utils.rethrow('Build failed!'));
    },

    steps: repository,
    blocks: blocks,
    templates: templates
};
