var utils = require('tribe/utilities/resources'),
    _ = require('underscore'),
    fs = require('q-io/fs'),
    Q = require('q');

module.exports = function (property, path, recursive) {
    return function (context) {
        return utils.listTree(path, recursive).then(function (files) {
            return Q.all(_.map(files, loadFile));
        });

        function loadFile(filePath) {
            return fs.read(filePath).then(function (content) {
                context[property] = context[property] || [];
                context[property].push({
                    path: filePath,
                    content: utils.stripBOM(content)
                });
            });
        }
    };
};