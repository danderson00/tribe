var utils = require('tribe/utilities'),
    _ = require('underscore'),
    fs = require('q-io/fs'),
    Q = require('q');

module.exports = function (property, path, filter, recursive) {
    return function (context) {
        return utils.files.listTree(utils.paths.resolveAppPath(path), filter, recursive).then(function (files) {
            return Q.all(_.map(files, loadFile));
        });

        function loadFile(filePath) {
            return fs.read(filePath).then(function (content) {
                context[property] = context[property] || [];
                context[property].push({
                    path: filePath,
                    appPath: utils.paths.appPathFor(filePath),
                    resourcePath: utils.paths.resourcePathFor(filePath, path),
                    content: utils.files.stripBOM(content)
                });
            });
        }
    };
};