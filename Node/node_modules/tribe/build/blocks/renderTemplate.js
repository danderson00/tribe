var utils = require('tribe/utilities'),
    options = require('tribe/options'),
    templates = require('tribe/build').templates,
    path = require('path'),
    fs = require('q-io/fs'),
    _ = require('underscore');

module.exports = function (name) {
    var render = {
        to: function (targetPath) {
            return function (context) {
                var content,
                    templateData = {
                        utils: utils,
                        context: context,
                        options: options,
                        _: _
                    };

                try {
                    content = _.template(templates(name), templateData);
                } catch (ex) {
                    utils.rethrow("Error rendering template '" + name + "' to " + targetPath)(ex);
                }

                if (targetPath)
                    return fs.write(utils.paths.resolveAppPath(targetPath), content);
                else
                    return content;
            };
        },
        toBuild: function (filename) {
            return function (context, options) {
                return render.to(path.join(options.buildPath, filename))(context);
            };
        }
    };
    return render;
};