var utils = require('tribe/utilities'),
    fs = require('q-io/fs'),
    q = require('q'),
    path = require('path'),
    _ = require('underscore');

module.exports = {
    requireDirectory: function (path, recursive) {
        return module.exports.enumerateFiles(path, require, recursive);
    },
    enumerateFiles: function (directoryPath, callback, recursive) {
        directoryPath = path.normalize(directoryPath);
        return fs.listTree(directoryPath, guard)
            .then(function (filePaths) {
                var promises = _.map(filePaths, function (filePath) {
                    filePath = path.normalize(filePath);
                    return callback(filePath, filePath.replace(directoryPath, ''));
                });
                return q.all(promises);
            })
        .fail(utils.rethrow('Error enumerating directory: ' + directoryPath));

        function guard(path, stat) {
            if (stat.isDirectory())
                return (path.toUpperCase() === directoryPath.toUpperCase() || recursive !== false) ? false : null;
            return true;
        }
    }

};