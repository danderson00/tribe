var Mocha = require('mocha'),
    testRequire = require('tribe/test/require'),
    channels = require('tribe/server/channels'),
    convert = require('./convert');

module.exports = {
    run: function (suite) {
        var runner = new Mocha.Runner(suite);

        runner.on('test', function (test) {
            broadcastEvent('test.start', test);
            testRequire.enable();
        });

        runner.on('fail', function (test, error) {
            testRequire.disable();
            test.error = error;
            broadcastEvent('test.complete', test, error);
        });

        runner.on('pass', function (test) {
            testRequire.disable();
            broadcastEvent('test.complete', test);
        });

        runner.run();
    },
};

function broadcastEvent(topic, test, error) {
    channels.broadcastTo('__test', { topic: topic, data: convert.test(test, error) });
}
