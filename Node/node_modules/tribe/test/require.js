var Module = require('module'),
    utils = require('tribe/utilities'),
    originalLoader = Module._load,
    refresh = false,
    stubbed,
    loaded;

module.exports = {
    enable: function () {
        stubbed = {};
        loaded = [];
        var loader = Module._load = function (request, parent, isMain) {
            if (stubbed[request])
                return stubbed[request];

            if (refresh) {
                // if this is the first time we've loaded a module, ensure it is refreshed
                var modulePath = Module._resolveFilename(request, parent);
                if (loaded.indexOf(modulePath) === -1) {
                    utils.clearCache(modulePath);
                    loaded.push(modulePath);
                }
            }

            return originalLoader(request, parent, isMain);
        };
    },
    forceRefresh: function () {
        refresh = true;
    },
    disable: function () {
        Module._load = originalLoader;
        refresh = false;
        stubbed = {};
        loaded = [];
    },
    stub: function (request, target) {
        return stubbed[request] = target;
    }
};

