var options = require('tribe/options'),
    process = require('tribe/process'),
    watcher = require('tribe/utilities/watcher'),
    _ = require('underscore'),
    runner;

module.exports = {
    start: function () {
        // need to delay this as it won't be initialised yet. A bit nasty.
        var test = require('tribe/test');

        // test channel should be an option
        runner = process.start('tribe/test/client', '__test', options.test.debugPort);

        var restart = _.throttle(runner.restart, options.test.restartThrottle, { leading: false });

        _.each(options.testPaths, function (path) {
            watcher.watch(path, {
                createOrUpdate: function (changePath) {
                    test.loadFile(changePath, changePath.replace(path, ''));
                    restart();
                },
                'delete': function (deletePath) {
                    test.removeFile(deletePath);
                    restart();
                }
            })
        });

        // moduleFolder is wrong, just for testing source development for now
        watcher.watch(options.modulePath, {
            createOrUpdate: function (changePath) {
                restart();
            }
        });
    }
};