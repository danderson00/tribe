"undefined"==typeof Tribe&&(Tribe={}),Tribe.PubSub=function(t){function i(t){function c(r){var n=s("exceptionHandler");if(s("handleExceptions")&&n)try{r(t.data,t)}catch(e){n(e,t)}else r(t.data,t)}for(var n=e.get(t.topic),i=t.sync===!0||r.sync===!0,u=0,o=n.length;o>u;u++)i?c(n[u].handler):!function(t){setTimeout(function(){c(t.handler)})}(n[u])}function u(t,r){return t&&t.topic?t:{topic:t,data:r}}function s(t){return r.options.hasOwnProperty(t)?r.options[t]:Tribe.PubSub.options[t]}var r=this,n=Tribe.PubSub.utils;this.owner=this,this.options=t||{},this.sync=s("sync");var e=new Tribe.PubSub.SubscriberList;this.subscribers=e,this.publish=function(t,r){return i(u(t,r))},this.publishSync=function(t,r){var n=u(t,r);return n.sync=!0,i(n)},this.subscribe=function(t,r){return"string"==typeof t?e.add(t,r):n.isArray(t)?n.map(t,function(t){return e.add(t,r)}):n.map(t,function(t,r){return e.add(r,t)})},this.unsubscribe=function(t){if(Tribe.PubSub.utils.isArray(t)){for(var r=[],n=0,i=t.length;i>n;n++)r.push(e.remove(t[n]));return r}return e.remove(t)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(r,r)},this.channel=function(t){return new Tribe.PubSub.Channel(r,t)}},Tribe.PubSub.Channel=function(t,r){function e(t,n){var e=t&&t.topic?t:{topic:t,data:n};return e.channelId=r,e}function i(t){return function(n,e){e.channelId===r&&t(n,e)}}var n=this;t=t.createLifetime(),this.id=r,this.owner=t.owner,this.publish=function(r,n){return t.publish(e(r,n))},this.publishSync=function(r,n){return t.publishSync(e(r,n))},this.subscribe=function(r,n){return t.subscribe(r,i(n))},this.subscribeOnce=function(r,n){return t.subscribeOnce(r,i(n))},this.unsubscribe=function(r){return t.unsubscribe(r)},this.end=function(){return t.end()},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.Lifetime=function(t,r){function i(t){return Tribe.PubSub.utils.isArray(t)?e=e.concat(t):e.push(t),t}var n=this,e=[];this.owner=r,this.publish=function(r,n){return t.publish(r,n)},this.publishSync=function(r,n){return t.publishSync(r,n)},this.subscribe=function(r,n){var e=t.subscribe(r,n);return i(e)},this.subscribeOnce=function(r,n){var e=t.subscribeOnce(r,n);return i(e)},this.unsubscribe=function(r){return t.unsubscribe(r)},this.channel=function(t){return new Tribe.PubSub.Channel(n,t)},this.end=function(){return t.unsubscribe(e)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(t,r){"undefined"!=typeof console&&console.log("Exception occurred in subscriber to '"+r.topic+"': "+Tribe.PubSub.utils.errorDetails(t))}},Tribe.PubSub.prototype.subscribeOnce=function(t,r){function u(){var n={};return e.each(t,function(t){n[t]=o(r)}),n}function s(){return e.map(t,function(t,r){return i.subscribe(r,o(t))})}function o(t){return function(){i.end(),t.apply(n,arguments)}}var n=this,e=Tribe.PubSub.utils,i=this.createLifetime();return"string"==typeof t?i.subscribe(t,o(r)):i.subscribe(e.isArray(t)?u():s())},Tribe.PubSub.SubscriberList=function(){function n(t,r){if("*"===r)return!0;var n="^"+r.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return t.match(n)}var t={},r=-1;this.get=function(r){var e=[];for(var i in t)t.hasOwnProperty(i)&&n(r,i)&&(e=e.concat(t[i]));return e},this.add=function(n,e){var i=(++r).toString();return t.hasOwnProperty(n)||(t[n]=[]),t[n].push({topic:n,handler:e,token:i}),i},this.remove=function(r){for(var n in t)if(t.hasOwnProperty(n))for(var e=0,i=t[n].length;i>e;e++)if(t[n][e].token===r)return t[n].splice(e,1),r;return!1}},Tribe.PubSub.utils={},function(t){t.isArray=function(t){return t.constructor===Array};var r=Array.prototype.forEach,n=Array.prototype.map,e={};t.each=function(t,n,i){if(null!=t)if(r&&t.forEach===r)t.forEach(n,i);else if(t.length===+t.length){for(var u=0,s=t.length;s>u;u++)if(n.call(i,t[u],u,t)===e)return}else for(var o in t)if(t.hasOwnProperty(o)&&n.call(i,t[o],o,t)===e)return},t.map=function(r,e,i){var u=[];return null==r?u:n&&r.map===n?r.map(e,i):(t.each(r,function(t,r,n){u[u.length]=e.call(i,t,r,n)}),u)},t.copyProperties=function(t,r,n){for(var e=0,i=n.length;i>e;e++){var u=n[e];t.hasOwnProperty(u)&&(r[u]=t[u])}},t.errorDetails=function(r){return r?r.constructor===String?r:(r.stack||"")+(r.inner?"\n\n"+t.errorDetails(r.inner):"\n"):""}}(Tribe.PubSub.utils),function(){var t=Tribe.PubSub.utils;Tribe.PubSub.Actor=function(t,r){function e(){r&&(r.constructor===Function?r(n):Tribe.PubSub.utils.copyProperties(r,n,["handles","endsChildrenExplicitly","onstart","onresume","onsuspend","onend"]))}var n=this;t=t.createLifetime(),this.pubsub=t,this.children=[],e(),this.handles=this.handles||{},this.topics=Object.keys(this.handles)},Tribe.PubSub.Actor.prototype.start=function(r){return t.each(this.handles,this.addHandler,this),this.onstart&&this.onstart(r,this),this},Tribe.PubSub.Actor.prototype.startChild=function(t,r){return this.children.push(new Tribe.PubSub.Actor(this.pubsub,t).start(r)),this},Tribe.PubSub.Actor.prototype.resume=function(r,n){return t.each(this.handles,this.addHandler,this),this.data=r,this.onresume&&this.onresume(n,this),this},Tribe.PubSub.Actor.prototype.suspend=function(t){return this.onsuspend&&this.onsuspend(t,this),this.pubsub.end(),this.suspendChildren(t),this},Tribe.PubSub.Actor.prototype.end=function(t){return this.onend&&this.onend(t,this),this.pubsub.end(),this.endChildren(t),this},Tribe.PubSub.Actor.prototype.endChildren=function(t){Tribe.PubSub.utils.each(this.children,function(r){r.end(t)})},Tribe.PubSub.Actor.prototype.suspendChildren=function(t){Tribe.PubSub.utils.each(this.children,function(r){r.suspend(t)})},Tribe.PubSub.Actor.startActor=function(t,r){return new Tribe.PubSub.Actor(this,t).start(r)},Tribe.PubSub.prototype.startActor=Tribe.PubSub.Actor.startActor,Tribe.PubSub.Lifetime.prototype.startActor=Tribe.PubSub.Actor.startActor}(),Tribe.PubSub.Actor.prototype.addHandler=function(t,r){function e(t){return function(r,e){n.endsChildrenExplicitly||n.endChildren(r),n.preMessage&&n.preMessage(e),t(r,e,n),n.postMessage&&n.postMessage(e)}}function i(t){return function(r){n.startChild({handles:t},r)}}function u(){return function(t){n.end(t)}}var n=this;t?t.constructor===Function?this.pubsub.subscribe(r,e(t)):this.pubsub.subscribe(r,i(t)):this.pubsub.subscribe(r,u())},"undefined"!=typeof module&&(module.exports=new Tribe.PubSub);