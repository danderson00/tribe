"undefined"==typeof Tribe&&(Tribe={}),Tribe.PubSub=function(e){function a(e){function l(t){var n=o("exceptionHandler");if(o("handleExceptions")&&n)try{t(e.data,e)}catch(i){n(i,e)}else t(e.data,e)}for(var n=i.get(e.topic),a=e.sync===!0||t.sync===!0,r=0,s=n.length;s>r;r++)a?l(n[r].handler):!function(e){setTimeout(function(){l(e.handler)})}(n[r])}function r(e,t){return e&&e.topic?e:{topic:e,data:t}}function o(e){return t.options.hasOwnProperty(e)?t.options[e]:Tribe.PubSub.options[e]}var t=this,n=Tribe.PubSub.utils;this.owner=this,this.options=e||{},this.sync=o("sync");var i=new Tribe.PubSub.SubscriberList;this.subscribers=i,this.publish=function(e,t){return a(r(e,t))},this.publishSync=function(e,t){var n=r(e,t);return n.sync=!0,a(n)},this.subscribe=function(e,t){return"string"==typeof e?i.add(e,t):n.isArray(e)?n.map(e,function(e){return i.add(e,t)}):n.map(e,function(e,t){return i.add(t,e)})},this.unsubscribe=function(e){if(Tribe.PubSub.utils.isArray(e)){for(var t=[],n=0,a=e.length;a>n;n++)t.push(i.remove(e[n]));return t}return i.remove(e)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(t,t)},this.channel=function(e){return new Tribe.PubSub.Channel(t,e)}},Tribe.PubSub.Channel=function(e,t){function i(e,n){var i=e&&e.topic?e:{topic:e,data:n};return i.channelId=t,i}function a(e){return function(n,i){i.channelId===t&&e(n,i)}}var n=this;e=e.createLifetime(),this.id=t,this.owner=e.owner,this.publish=function(t,n){return e.publish(i(t,n))},this.publishSync=function(t,n){return e.publishSync(i(t,n))},this.subscribe=function(t,n){return e.subscribe(t,a(n))},this.subscribeOnce=function(t,n){return e.subscribeOnce(t,a(n))},this.unsubscribe=function(t){return e.unsubscribe(t)},this.end=function(){return e.end()},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.Lifetime=function(e,t){function a(e){return Tribe.PubSub.utils.isArray(e)?i=i.concat(e):i.push(e),e}var n=this,i=[];this.owner=t,this.publish=function(t,n){return e.publish(t,n)},this.publishSync=function(t,n){return e.publishSync(t,n)},this.subscribe=function(t,n){var i=e.subscribe(t,n);return a(i)},this.subscribeOnce=function(t,n){var i=e.subscribeOnce(t,n);return a(i)},this.unsubscribe=function(t){return e.unsubscribe(t)},this.channel=function(e){return new Tribe.PubSub.Channel(n,e)},this.end=function(){return e.unsubscribe(i)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(e,t){"undefined"!=typeof console&&console.log("Exception occurred in subscriber to '"+t.topic+"': "+Tribe.PubSub.utils.errorDetails(e))}},Tribe.PubSub.prototype.subscribeOnce=function(e,t){function r(){var n={};return i.each(e,function(e){n[e]=s(t)}),n}function o(){return i.map(e,function(e,t){return a.subscribe(t,s(e))})}function s(e){return function(){a.end(),e.apply(n,arguments)}}var n=this,i=Tribe.PubSub.utils,a=this.createLifetime();return"string"==typeof e?a.subscribe(e,s(t)):i.isArray(e)?a.subscribe(r()):a.subscribe(o())},Tribe.PubSub.SubscriberList=function(){function n(e,t){if("*"===t)return!0;var n="^"+t.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return e.match(n)}var e={},t=-1;this.get=function(t){var i=[];for(var a in e)e.hasOwnProperty(a)&&n(t,a)&&(i=i.concat(e[a]));return i},this.add=function(n,i){var a=(++t).toString();return e.hasOwnProperty(n)||(e[n]=[]),e[n].push({topic:n,handler:i,token:a}),a},this.remove=function(t){for(var n in e)if(e.hasOwnProperty(n))for(var i=0,a=e[n].length;a>i;i++)if(e[n][i].token===t)return e[n].splice(i,1),t;return!1}},Tribe.PubSub.utils={},function(e){e.isArray=function(e){return e.constructor===Array};var t=Array.prototype.forEach,n=Array.prototype.map,i={};e.each=function(e,n,a){if(null!=e)if(t&&e.forEach===t)e.forEach(n,a);else if(e.length===+e.length){for(var r=0,o=e.length;o>r;r++)if(n.call(a,e[r],r,e)===i)return}else for(var s in e)if(e.hasOwnProperty(s)&&n.call(a,e[s],s,e)===i)return},e.map=function(t,i,a){var r=[];return null==t?r:n&&t.map===n?t.map(i,a):(e.each(t,function(e,t,n){r[r.length]=i.call(a,e,t,n)}),r)},e.copyProperties=function(e,t,n){for(var i=0,a=n.length;a>i;i++){var r=n[i];e.hasOwnProperty(r)&&(t[r]=e[r])}},e.errorDetails=function(t){return t?t.constructor===String?t:(t.stack||"")+(t.inner?"\n\n"+e.errorDetails(t.inner):"\n"):""}}(Tribe.PubSub.utils),function(){var e=Tribe.PubSub.utils;Tribe.PubSub.Actor=function(e,t){function i(){t&&(t.constructor===Function?t(n):Tribe.PubSub.utils.copyProperties(t,n,["handles","endsChildrenExplicitly"]))}var n=this;e=e.createLifetime(),this.pubsub=e,this.children=[],i(),this.handles=this.handles||{},this.topics=Object.keys(this.handles)},Tribe.PubSub.Actor.prototype.start=function(t){return e.each(this.handles,this.addHandler,this),this.handles.onstart&&this.handles.onstart(t,this),this},Tribe.PubSub.Actor.prototype.startChild=function(e,t){return this.children.push(new Tribe.PubSub.Actor(this.pubsub,e).start(t)),this},Tribe.PubSub.Actor.prototype.join=function(t,n){return e.each(this.handles,this.addHandler,this),this.data=t,this.handles.onjoin&&this.handles.onjoin(n,this),this},Tribe.PubSub.Actor.prototype.end=function(e){return this.handles.onend&&this.handles.onend(e,this),this.pubsub.end(),this.endChildren(e),this},Tribe.PubSub.Actor.prototype.endChildren=function(e){Tribe.PubSub.utils.each(this.children,function(t){t.end(e)})},Tribe.PubSub.Actor.startActor=function(e,t){return new Tribe.PubSub.Actor(this,e).start(t)},Tribe.PubSub.prototype.startActor=Tribe.PubSub.Actor.startActor,Tribe.PubSub.Lifetime.prototype.startActor=Tribe.PubSub.Actor.startActor}(),Tribe.PubSub.Actor.prototype.addHandler=function(e,t){function i(e){return function(t,i){n.endsChildrenExplicitly||n.endChildren(t),e(t,i,n)}}function a(e){return function(t){n.startChild({handles:e},t)}}function r(){return function(e){n.end(e)}}var n=this;"onstart"!==t&&"onend"!==t&&"onjoin"!==t&&(e?e.constructor===Function?this.pubsub.subscribe(t,i(e)):this.pubsub.subscribe(t,a(e)):this.pubsub.subscribe(t,r()))},"undefined"!=typeof module&&(module.exports=new Tribe.PubSub);