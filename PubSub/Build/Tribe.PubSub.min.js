"undefined"==typeof Tribe&&(Tribe={}),Tribe.PubSub=function(t){function e(t){function c(r){var n=s("exceptionHandler");if(s("handleExceptions")&&n)try{r(t.data,t)}catch(i){n(i,t)}else r(t.data,t)}for(var n=i.get(t.topic),e=t.sync===!0||r.sync===!0,u=0,o=n.length;o>u;u++)e?c(n[u].handler):!function(t){setTimeout(function(){c(t.handler)})}(n[u])}function u(t,r){return t&&t.topic?t:{topic:t,data:r}}function s(t){return r.options.hasOwnProperty(t)?r.options[t]:Tribe.PubSub.options[t]}var r=this,n=Tribe.PubSub.utils;this.owner=this,this.options=t||{},this.sync=s("sync");var i=new Tribe.PubSub.SubscriberList;this.subscribers=i,this.publish=function(t,r){return e(u(t,r))},this.publishSync=function(t,r){var n=u(t,r);return n.sync=!0,e(n)},this.subscribe=function(t,r){return"string"==typeof t?i.add(t,r):n.isArray(t)?n.map(t,function(t){return i.add(t,r)}):n.map(t,function(t,r){return i.add(r,t)})},this.unsubscribe=function(t){if(Tribe.PubSub.utils.isArray(t)){for(var r=[],n=0,e=t.length;e>n;n++)r.push(i.remove(t[n]));return r}return i.remove(t)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(r,r)},this.channel=function(t){return new Tribe.PubSub.Channel(r,t)}},Tribe.PubSub.Channel=function(t,r){function i(t,n){var i=t&&t.topic?t:{topic:t,data:n};return i.channelId=r,i}function e(t){return function(n,i){i.channelId===r&&t(n,i)}}var n=this;t=t.createLifetime(),this.id=r,this.owner=t.owner,this.publish=function(r,n){return t.publish(i(r,n))},this.publishSync=function(r,n){return t.publishSync(i(r,n))},this.subscribe=function(r,n){return t.subscribe(r,e(n))},this.subscribeOnce=function(r,n){return t.subscribeOnce(r,e(n))},this.unsubscribe=function(r){return t.unsubscribe(r)},this.end=function(){return t.end()},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.Lifetime=function(t,r){function e(t){return Tribe.PubSub.utils.isArray(t)?i=i.concat(t):i.push(t),t}var n=this,i=[];this.owner=r,this.publish=function(r,n){return t.publish(r,n)},this.publishSync=function(r,n){return t.publishSync(r,n)},this.subscribe=function(r,n){var i=t.subscribe(r,n);return e(i)},this.subscribeOnce=function(r,n){var i=t.subscribeOnce(r,n);return e(i)},this.unsubscribe=function(r){return t.unsubscribe(r)},this.channel=function(t){return new Tribe.PubSub.Channel(n,t)},this.end=function(){return t.unsubscribe(i)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(t,r){"undefined"!=typeof console&&console.log("Exception occurred in subscriber to '"+r.topic+"': "+Tribe.PubSub.utils.errorDetails(t))}},Tribe.PubSub.prototype.subscribeOnce=function(t,r){function u(){var n={};return i.each(t,function(t){n[t]=o(r)}),n}function s(){return i.map(t,function(t,r){return e.subscribe(r,o(t))})}function o(t){return function(){e.end(),t.apply(n,arguments)}}var n=this,i=Tribe.PubSub.utils,e=this.createLifetime();return"string"==typeof t?e.subscribe(t,o(r)):e.subscribe(i.isArray(t)?u():s())},Tribe.PubSub.SubscriberList=function(){function n(t,r){if("*"===r)return!0;var n="^"+r.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return t.match(n)}var t={},r=-1;this.get=function(r){var i=[];for(var e in t)t.hasOwnProperty(e)&&n(r,e)&&(i=i.concat(t[e]));return i},this.add=function(n,i){var e=(++r).toString();return t.hasOwnProperty(n)||(t[n]=[]),t[n].push({topic:n,handler:i,token:e}),e},this.remove=function(r){for(var n in t)if(t.hasOwnProperty(n))for(var i=0,e=t[n].length;e>i;i++)if(t[n][i].token===r)return t[n].splice(i,1),r;return!1}},Tribe.PubSub.utils={},function(t){t.isArray=function(t){return t.constructor===Array};var r=Array.prototype.forEach,n=Array.prototype.map,i={};t.each=function(t,n,e){if(null!=t)if(r&&t.forEach===r)t.forEach(n,e);else if(t.length===+t.length){for(var u=0,s=t.length;s>u;u++)if(n.call(e,t[u],u,t)===i)return}else for(var o in t)if(t.hasOwnProperty(o)&&n.call(e,t[o],o,t)===i)return},t.map=function(r,i,e){var u=[];return null==r?u:n&&r.map===n?r.map(i,e):(t.each(r,function(t,r,n){u[u.length]=i.call(e,t,r,n)}),u)},t.copyProperties=function(t,r,n){for(var i=0,e=n.length;e>i;i++){var u=n[i];t.hasOwnProperty(u)&&(r[u]=t[u])}},t.errorDetails=function(r){return r?r.constructor===String?r:(r.stack||"")+(r.inner?"\n\n"+t.errorDetails(r.inner):"\n"):""}}(Tribe.PubSub.utils),function(){var t=Tribe.PubSub.utils;Tribe.PubSub.Actor=function(t,r){function i(){r&&(r.constructor===Function?r(n):Tribe.PubSub.utils.copyProperties(r,n,["handles","endsChildrenExplicitly","onstart","onjoin","onend"]))}var n=this;t=t.createLifetime(),this.pubsub=t,this.children=[],i(),this.handles=this.handles||{},this.topics=Object.keys(this.handles)},Tribe.PubSub.Actor.prototype.start=function(r){return t.each(this.handles,this.addHandler,this),this.onstart&&this.onstart(r,this),this},Tribe.PubSub.Actor.prototype.startChild=function(t,r){return this.children.push(new Tribe.PubSub.Actor(this.pubsub,t).start(r)),this},Tribe.PubSub.Actor.prototype.join=function(r,n){return t.each(this.handles,this.addHandler,this),this.data=r,this.onjoin&&this.onjoin(n,this),this},Tribe.PubSub.Actor.prototype.end=function(t){return this.onend&&this.onend(t,this),this.pubsub.end(),this.endChildren(t),this},Tribe.PubSub.Actor.prototype.endChildren=function(t){Tribe.PubSub.utils.each(this.children,function(r){r.end(t)})},Tribe.PubSub.Actor.startActor=function(t,r){return new Tribe.PubSub.Actor(this,t).start(r)},Tribe.PubSub.prototype.startActor=Tribe.PubSub.Actor.startActor,Tribe.PubSub.Lifetime.prototype.startActor=Tribe.PubSub.Actor.startActor}(),Tribe.PubSub.Actor.prototype.addHandler=function(t,r){function i(t){return function(r,i){n.endsChildrenExplicitly||n.endChildren(r),n.preMessage&&n.preMessage(i),t(r,i,n),n.postMessage&&n.postMessage(i)}}function e(t){return function(r){n.startChild({handles:t},r)}}function u(){return function(t){n.end(t)}}var n=this;"onstart"!==r&&"onend"!==r&&"onjoin"!==r&&(t?t.constructor===Function?this.pubsub.subscribe(r,i(t)):this.pubsub.subscribe(r,e(t)):this.pubsub.subscribe(r,u()))},"undefined"!=typeof module&&(module.exports=new Tribe.PubSub);