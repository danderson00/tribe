window.Tribe=window.Tribe||{},Tribe.PubSub=function(e){function i(e){function l(t){var n=r("exceptionHandler");if(r("handleExceptions"))try{t(e.data,e)}catch(a){n&&n(a,e)}else t(e.data,e)}for(var n=a.get(e.topic),i=e.sync===!0||t.sync===!0,s=0,o=n.length;o>s;s++)i?l(n[s].handler):!function(e){setTimeout(function(){l(e.handler)})}(n[s])}function s(e,t){return e&&e.topic?e:{topic:e,data:t}}function r(t){return e&&e.hasOwnProperty(t)?e[t]:Tribe.PubSub.options[t]}var t=this,n=Tribe.PubSub.utils;this.owner=this,this.sync=r("sync");var a=new Tribe.PubSub.SubscriberList;this.subscribers=a,this.publish=function(e,t){return i(s(e,t))},this.publishSync=function(e,t){var n=s(e,t);return n.sync=!0,i(n)},this.subscribe=function(e,t){return"string"==typeof e?a.add(e,t):n.isArray(e)?n.map(e,function(e){return a.add(e,t)}):n.map(e,function(e,t){return a.add(t,e)})},this.unsubscribe=function(e){if(Tribe.PubSub.utils.isArray(e)){for(var t=[],n=0,i=e.length;i>n;n++)t.push(a.remove(e[n]));return t}return a.remove(e)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(t,t)},this.channel=function(e){return new Tribe.PubSub.Channel(t,e)}},Tribe.PubSub.Channel=function(e,t){function n(e,n){var a=e&&e.topic?e:{topic:e,data:n};return a.channelId=t,a}function a(e){return function(n,a){a.channelId===t&&e(n,a)}}e=e.createLifetime(),this.id=t,this.publish=function(t,a){return e.publish(n(t,a))},this.publishSync=function(t,a){return e.publishSync(n(t,a))},this.subscribe=function(t,n){return e.subscribe(t,a(n))},this.subscribeOnce=function(t,n){return e.subscribeOnce(t,a(n))},this.unsubscribe=function(t){return e.unsubscribe(t)},this.end=function(){return e.end()}},Tribe.PubSub.Lifetime=function(e,t){function i(e){return Tribe.PubSub.utils.isArray(e)?a=a.concat(e):a.push(e),e}var n=this,a=[];this.owner=t,this.publish=function(t,n){return e.publish(t,n)},this.publishSync=function(t,n){return e.publishSync(t,n)},this.subscribe=function(t,n){var a=e.subscribe(t,n);return i(a)},this.subscribeOnce=function(t,n){var a=e.subscribeOnce(t,n);return i(a)},this.unsubscribe=function(t){return e.unsubscribe(t)},this.channel=function(e){return new Tribe.PubSub.Channel(n,e)},this.end=function(){return e.unsubscribe(a)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},window.Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(e,t){window.console&&console.log("Exception occurred in subscriber to '"+t.topic+"': "+e.message)}},Tribe.PubSub.Saga=function(e,t){function r(t,n){"onstart"!==n&&"onend"!==n&&(t?t.constructor===Function?e.subscribe(n,o(t)):e.subscribe(n,l(t)):e.subscribe(n,d()))}function o(e){return function(n,i){t.endsChildrenExplicitly||p(n),e(n,i,a)}}function l(e){return function(t){a.startChild({handles:e},t)}}function d(){return function(e){a.end(e)}}function p(e){Tribe.PubSub.utils.each(a.children,function(t){t.end(e)})}function c(e,t){if(e.constructor===Function){var n=[a].concat(t);e=i.applyToConstructor(e,n)}return e}var a=this,i=Tribe.PubSub.utils;e=e.createLifetime(),this.pubsub=e,this.children=[],t=c(t,Array.prototype.slice.call(arguments,2));var s=t.handles||{};this.start=function(e){return i.each(s,r),s.onstart&&s.onstart(e,a),a},this.startChild=function(t){return a.children.push(new Tribe.PubSub.Saga(e,c(t,Array.prototype.slice.call(arguments,1))).start()),a},this.end=function(t){return s.onend&&s.onend(t,a),e.end(),p(t),a}},Tribe.PubSub.Saga.startSaga=function(e){var n=[this,e].concat(Array.prototype.slice.call(arguments,1)),a=Tribe.PubSub.utils.applyToConstructor(Tribe.PubSub.Saga,n);return a.start()},Tribe.PubSub.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.Lifetime.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.prototype.subscribeOnce=function(e,t){function s(){var n={};return a.each(e,function(e){n[e]=o(t)}),n}function r(){return a.map(e,function(e,t){return i.subscribe(t,o(e))})}function o(e){return function(){i.end(),e.apply(n,arguments)}}var n=this,a=Tribe.PubSub.utils,i=this.createLifetime();return"string"==typeof e?i.subscribe(e,o(t)):a.isArray(e)?i.subscribe(s()):i.subscribe(r())},Tribe.PubSub.SubscriberList=function(){function n(e,t){if("*"===t)return!0;var n="^"+t.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return e.match(n)}var e={},t=-1;this.get=function(t){var a=[];for(var i in e)e.hasOwnProperty(i)&&n(t,i)&&(a=a.concat(e[i]));return a},this.add=function(n,a){var i=(++t).toString();return e.hasOwnProperty(n)||(e[n]=[]),e[n].push({topic:n,handler:a,token:i}),i},this.remove=function(t){for(var n in e)if(e.hasOwnProperty(n))for(var a=0,i=e[n].length;i>a;a++)if(e[n][a].token===t)return e[n].splice(a,1),t;return!1}},Tribe.PubSub.utils={},function(e){e.isArray=function(e){return e.constructor===Array},e.applyToConstructor=function(e,t){var a,i,n=function(){};return n.prototype=e.prototype,a=new n,i=e.apply(a,t),Object(i)===i?i:a};var t=Array.prototype.forEach,n=Array.prototype.map,a={};e.each=function(e,n,i){if(null!=e)if(t&&e.forEach===t)e.forEach(n,i);else if(e.length===+e.length){for(var s=0,r=e.length;r>s;s++)if(n.call(i,e[s],s,e)===a)return}else for(var o in e)if(e.hasOwnProperty(o)&&n.call(i,e[o],o,e)===a)return},e.map=function(t,a,i){var s=[];return null==t?s:n&&t.map===n?t.map(a,i):(e.each(t,function(e,t,n){s[s.length]=a.call(i,e,t,n)}),s)}}(Tribe.PubSub.utils);