"undefined"==typeof Tribe&&(Tribe={}),Tribe.PubSub=function(e){function r(e){function u(t){var n=a("exceptionHandler");if(a("handleExceptions"))try{t(e.data,e)}catch(i){n&&n(i,e)}else t(e.data,e)}for(var n=i.get(e.topic),r=e.sync===!0||t.sync===!0,o=0,s=n.length;s>o;o++)r?u(n[o].handler):!function(e){setTimeout(function(){u(e.handler)})}(n[o])}function o(e,t){return e&&e.topic?e:{topic:e,data:t}}function a(t){return e&&e.hasOwnProperty(t)?e[t]:Tribe.PubSub.options[t]}var t=this,n=Tribe.PubSub.utils;this.owner=this,this.sync=a("sync");var i=new Tribe.PubSub.SubscriberList;this.subscribers=i,this.publish=function(e,t){return r(o(e,t))},this.publishSync=function(e,t){var n=o(e,t);return n.sync=!0,r(n)},this.subscribe=function(e,t){return"string"==typeof e?i.add(e,t):n.isArray(e)?n.map(e,function(e){return i.add(e,t)}):n.map(e,function(e,t){return i.add(t,e)})},this.unsubscribe=function(e){if(Tribe.PubSub.utils.isArray(e)){for(var t=[],n=0,r=e.length;r>n;n++)t.push(i.remove(e[n]));return t}return i.remove(e)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(t,t)},this.channel=function(e){return new Tribe.PubSub.Channel(t,e)}},Tribe.PubSub.Channel=function(e,t){function i(e,n){var i=e&&e.topic?e:{topic:e,data:n};return i.channelId=t,i}function r(e){return function(n,i){i.channelId===t&&e(n,i)}}var n=this;e=e.createLifetime(),this.id=t,this.owner=e.owner,this.publish=function(t,n){return e.publish(i(t,n))},this.publishSync=function(t,n){return e.publishSync(i(t,n))},this.subscribe=function(t,n){return e.subscribe(t,r(n))},this.subscribeOnce=function(t,n){return e.subscribeOnce(t,r(n))},this.unsubscribe=function(t){return e.unsubscribe(t)},this.end=function(){return e.end()},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.Lifetime=function(e,t){function r(e){return Tribe.PubSub.utils.isArray(e)?i=i.concat(e):i.push(e),e}var n=this,i=[];this.owner=t,this.publish=function(t,n){return e.publish(t,n)},this.publishSync=function(t,n){return e.publishSync(t,n)},this.subscribe=function(t,n){var i=e.subscribe(t,n);return r(i)},this.subscribeOnce=function(t,n){var i=e.subscribeOnce(t,n);return r(i)},this.unsubscribe=function(t){return e.unsubscribe(t)},this.channel=function(e){return new Tribe.PubSub.Channel(n,e)},this.end=function(){return e.unsubscribe(i)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(e,t){window.console&&console.log("Exception occurred in subscriber to '"+t.topic+"': "+e.message)}},Tribe.PubSub.Saga=function(e,t){function o(){t&&(t.constructor===Function?t(n):Tribe.PubSub.utils.copyProperties(t,n,["handles","endsChildrenExplicitly"]))}var n=this,i=Tribe.PubSub.utils;e=e.createLifetime(),this.pubsub=e,this.children=[],o();var r=this.handles||{};this.topics=Object.keys(r),this.start=function(e){return i.each(r,n.addHandler,n),r.onstart&&r.onstart(e,n),n},this.startChild=function(t,i){return n.children.push(new Tribe.PubSub.Saga(e,t).start(i)),n},this.join=function(e,t){return i.each(r,n.addHandler,n),n.data=e,r.onjoin&&r.onjoin(t,n),n},this.end=function(t){return r.onend&&r.onend(t,n),e.end(),n.endChildren(t),n},this.endChildren=function(e){Tribe.PubSub.utils.each(n.children,function(t){t.end(e)})}},Tribe.PubSub.Saga.startSaga=function(e,t){return new Tribe.PubSub.Saga(this,e).start(t)},Tribe.PubSub.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.Lifetime.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.Saga.prototype.addHandler=function(e,t){function i(e){return function(t,i){n.endsChildrenExplicitly||n.endChildren(t),e(t,i,n)}}function r(e){return function(t){n.startChild({handles:e},t)}}function o(){return function(e){n.end(e)}}var n=this;"onstart"!==t&&"onend"!==t&&"onjoin"!==t&&(e?e.constructor===Function?this.pubsub.subscribe(t,i(e)):this.pubsub.subscribe(t,r(e)):this.pubsub.subscribe(t,o()))},Tribe.PubSub.prototype.subscribeOnce=function(e,t){function o(){var n={};return i.each(e,function(e){n[e]=s(t)}),n}function a(){return i.map(e,function(e,t){return r.subscribe(t,s(e))})}function s(e){return function(){r.end(),e.apply(n,arguments)}}var n=this,i=Tribe.PubSub.utils,r=this.createLifetime();return"string"==typeof e?r.subscribe(e,s(t)):i.isArray(e)?r.subscribe(o()):r.subscribe(a())},Tribe.PubSub.SubscriberList=function(){function n(e,t){if("*"===t)return!0;var n="^"+t.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return e.match(n)}var e={},t=-1;this.get=function(t){var i=[];for(var r in e)e.hasOwnProperty(r)&&n(t,r)&&(i=i.concat(e[r]));return i},this.add=function(n,i){var r=(++t).toString();return e.hasOwnProperty(n)||(e[n]=[]),e[n].push({topic:n,handler:i,token:r}),r},this.remove=function(t){for(var n in e)if(e.hasOwnProperty(n))for(var i=0,r=e[n].length;r>i;i++)if(e[n][i].token===t)return e[n].splice(i,1),t;return!1}},Tribe.PubSub.utils={},function(e){e.isArray=function(e){return e.constructor===Array};var t=Array.prototype.forEach,n=Array.prototype.map,i={};e.each=function(e,n,r){if(null!=e)if(t&&e.forEach===t)e.forEach(n,r);else if(e.length===+e.length){for(var o=0,a=e.length;a>o;o++)if(n.call(r,e[o],o,e)===i)return}else for(var s in e)if(e.hasOwnProperty(s)&&n.call(r,e[s],s,e)===i)return},e.map=function(t,i,r){var o=[];return null==t?o:n&&t.map===n?t.map(i,r):(e.each(t,function(e,t,n){o[o.length]=i.call(r,e,t,n)}),o)},e.copyProperties=function(e,t,n){for(var i=0,r=n.length;r>i;i++){var o=n[i];e.hasOwnProperty(o)&&(t[o]=e[o])}}}(Tribe.PubSub.utils),"undefined"!=typeof module&&(module.exports=new Tribe.PubSub);