"undefined"==typeof Tribe&&(Tribe={}),Tribe.PubSub=function(t){function r(t){function u(e){var n=a("exceptionHandler");if(a("handleExceptions")&&n)try{e(t.data,t)}catch(i){n(i,t)}else e(t.data,t)}for(var n=i.get(t.topic),r=t.sync===!0||e.sync===!0,o=0,s=n.length;s>o;o++)r?u(n[o].handler):!function(t){setTimeout(function(){u(t.handler)})}(n[o])}function o(t,e){return t&&t.topic?t:{topic:t,data:e}}function a(t){return e.options.hasOwnProperty(t)?e.options[t]:Tribe.PubSub.options[t]}var e=this,n=Tribe.PubSub.utils;this.owner=this,this.options=t||{},this.sync=a("sync");var i=new Tribe.PubSub.SubscriberList;this.subscribers=i,this.publish=function(t,e){return r(o(t,e))},this.publishSync=function(t,e){var n=o(t,e);return n.sync=!0,r(n)},this.subscribe=function(t,e){return"string"==typeof t?i.add(t,e):n.isArray(t)?n.map(t,function(t){return i.add(t,e)}):n.map(t,function(t,e){return i.add(e,t)})},this.unsubscribe=function(t){if(Tribe.PubSub.utils.isArray(t)){for(var e=[],n=0,r=t.length;r>n;n++)e.push(i.remove(t[n]));return e}return i.remove(t)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(e,e)},this.channel=function(t){return new Tribe.PubSub.Channel(e,t)}},Tribe.PubSub.Channel=function(t,e){function i(t,n){var i=t&&t.topic?t:{topic:t,data:n};return i.channelId=e,i}function r(t){return function(n,i){i.channelId===e&&t(n,i)}}var n=this;t=t.createLifetime(),this.id=e,this.owner=t.owner,this.publish=function(e,n){return t.publish(i(e,n))},this.publishSync=function(e,n){return t.publishSync(i(e,n))},this.subscribe=function(e,n){return t.subscribe(e,r(n))},this.subscribeOnce=function(e,n){return t.subscribeOnce(e,r(n))},this.unsubscribe=function(e){return t.unsubscribe(e)},this.end=function(){return t.end()},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.Lifetime=function(t,e){function r(t){return Tribe.PubSub.utils.isArray(t)?i=i.concat(t):i.push(t),t}var n=this,i=[];this.owner=e,this.publish=function(e,n){return t.publish(e,n)},this.publishSync=function(e,n){return t.publishSync(e,n)},this.subscribe=function(e,n){var i=t.subscribe(e,n);return r(i)},this.subscribeOnce=function(e,n){var i=t.subscribeOnce(e,n);return r(i)},this.unsubscribe=function(e){return t.unsubscribe(e)},this.channel=function(t){return new Tribe.PubSub.Channel(n,t)},this.end=function(){return t.unsubscribe(i)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(n,n.owner)}},Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(t,e){"undefined"!=typeof console&&console.log("Exception occurred in subscriber to '"+e.topic+"': "+Tribe.PubSub.utils.errorDetails(t))}},Tribe.PubSub.prototype.subscribeOnce=function(t,e){function o(){var n={};return i.each(t,function(t){n[t]=s(e)}),n}function a(){return i.map(t,function(t,e){return r.subscribe(e,s(t))})}function s(t){return function(){r.end(),t.apply(n,arguments)}}var n=this,i=Tribe.PubSub.utils,r=this.createLifetime();return"string"==typeof t?r.subscribe(t,s(e)):i.isArray(t)?r.subscribe(o()):r.subscribe(a())},Tribe.PubSub.SubscriberList=function(){function n(t,e){if("*"===e)return!0;var n="^"+e.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return t.match(n)}var t={},e=-1;this.get=function(e){var i=[];for(var r in t)t.hasOwnProperty(r)&&n(e,r)&&(i=i.concat(t[r]));return i},this.add=function(n,i){var r=(++e).toString();return t.hasOwnProperty(n)||(t[n]=[]),t[n].push({topic:n,handler:i,token:r}),r},this.remove=function(e){for(var n in t)if(t.hasOwnProperty(n))for(var i=0,r=t[n].length;r>i;i++)if(t[n][i].token===e)return t[n].splice(i,1),e;return!1}},Tribe.PubSub.utils={},function(t){t.isArray=function(t){return t.constructor===Array};var e=Array.prototype.forEach,n=Array.prototype.map,i={};t.each=function(t,n,r){if(null!=t)if(e&&t.forEach===e)t.forEach(n,r);else if(t.length===+t.length){for(var o=0,a=t.length;a>o;o++)if(n.call(r,t[o],o,t)===i)return}else for(var s in t)if(t.hasOwnProperty(s)&&n.call(r,t[s],s,t)===i)return},t.map=function(e,i,r){var o=[];return null==e?o:n&&e.map===n?e.map(i,r):(t.each(e,function(t,e,n){o[o.length]=i.call(r,t,e,n)}),o)},t.copyProperties=function(t,e,n){for(var i=0,r=n.length;r>i;i++){var o=n[i];t.hasOwnProperty(o)&&(e[o]=t[o])}},t.errorDetails=function(e){return e?e.constructor===String?e:(e.stack||"")+(e.inner?"\n\n"+t.errorDetails(e.inner):"\n"):""}}(Tribe.PubSub.utils),Tribe.PubSub.Actor=function(t,e){function o(){e&&(e.constructor===Function?e(n):Tribe.PubSub.utils.copyProperties(e,n,["handles","endsChildrenExplicitly"]))}var n=this,i=Tribe.PubSub.utils;t=t.createLifetime(),this.pubsub=t,this.children=[],o();var r=this.handles||{};this.topics=Object.keys(r),this.start=function(t){return i.each(r,n.addHandler,n),r.onstart&&r.onstart(t,n),n},this.startChild=function(e,i){return n.children.push(new Tribe.PubSub.Actor(t,e).start(i)),n},this.join=function(t,e){return i.each(r,n.addHandler,n),n.data=t,r.onjoin&&r.onjoin(e,n),n},this.end=function(e){return r.onend&&r.onend(e,n),t.end(),n.endChildren(e),n},this.endChildren=function(t){Tribe.PubSub.utils.each(n.children,function(e){e.end(t)})}},Tribe.PubSub.Actor.startActor=function(t,e){return new Tribe.PubSub.Actor(this,t).start(e)},Tribe.PubSub.prototype.startActor=Tribe.PubSub.Actor.startActor,Tribe.PubSub.Lifetime.prototype.startActor=Tribe.PubSub.Actor.startActor,Tribe.PubSub.Actor.prototype.addHandler=function(t,e){function i(t){return function(e,i){n.endsChildrenExplicitly||n.endChildren(e),t(e,i,n)}}function r(t){return function(e){n.startChild({handles:t},e)}}function o(){return function(t){n.end(t)}}var n=this;"onstart"!==e&&"onend"!==e&&"onjoin"!==e&&(t?t.constructor===Function?this.pubsub.subscribe(e,i(t)):this.pubsub.subscribe(e,r(t)):this.pubsub.subscribe(e,o()))},"undefined"!=typeof module&&(module.exports=new Tribe.PubSub);