var Q = require('q'),
    db = require('./db');

module.exports = function (name, version, upgrade) {
    var promise = Q.defer(),
        req = window.indexedDB.open(name, version);

    req.onupgradeneeded = function (event) {
        upgrade(event.target.result);
        //for (var i = 0, l = entities.length; i < l; i++) {
        //    var entity = entities[i],
        //        indexes = entity.indexes;

        //    store = result.createObjectStore(entity.name, { autoIncrement: true });
        //    for (var j = 0, l = indexes.length; j < l; j++)
        //        store.createIndex(indexName(indexes[i]), indexes[i]);
        //}
    };

    req.onsuccess = function (event) {
        promise.resolve(db(event.target.result));
    };

    req.onerror = function (event) {
        promise.reject(this.error);
    };

    return promise.promise;
};

function indexName(index) {
    if (index.constructor === Array)
        return index.join('_');
    return index;
}
