var queries = require('./queries'),
    keyPath = require('tribe.expressions/keyPath'),
    _ = require('underscore'),
    Q = require('q');

module.exports = function (entityData, database) {
    return {
        store: function (entities) {
            if (entities.constructor === Array) {
                var returnedEntities = [];
                return entities.map(storeEntity).reduce(function (promise, factory) {
                    return Q.when(promise).then(factory).then(function (returnedEntity) {
                        returnedEntities.push(returnedEntity);
                    })
                }, Q()).then(function () {
                    return returnedEntities;
                });
            }
            return storeEntity(entities)();

            // ergh...
            function storeEntity(entity) {
                return function () {
                    return database
                        .run(queries.store(entityData, entity))
                        .then(function (rowid) {
                            if (entityData.keyPath)
                                keyPath.set(entityData.keyPath, entity, rowid);

                            return queries.insertIndexes(entityData, entity, rowid)
                                .map(function (query) {
                                    return function () {
                                        return database.run(query);
                                    };
                                })
                                .reduce(Q.when, Q())
                                .then(function () {
                                    return entity;
                                });
                        });
                };
            }
        },
        retrieve: function (predicates) {
            return database.all(queries.retrieve(entityData, predicates)).then(function (rows) {
                return _.map(rows, function (row) {
                    var result = JSON.parse(row.content);
                    if (entityData.keyPath)
                        keyPath.set(entityData.keyPath, result, row.__rowid);
                    return result;
                });
            });
        },
        clear: function () {
            return database.run(queries.clear(entityData.name));
        }
    };
}
