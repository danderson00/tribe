var queries = require('./queries'),
    keyPath = require('tribe.expressions/keyPath'),
    _ = require('underscore'),
    Q = require('q');

module.exports = function (entityData, database) {
    return {
        store: function (entities) {
            return database.transaction(function (transaction) {
                if (entities.constructor === Array)
                    return Q.all(entities.map(storeEntity));
                return storeEntity(entities);

                function storeEntity(entity) {
                    return database
                        .run(queries.store(entityData, entity), transaction)
                        .then(function (rowid) {
                            if (entityData.keyPath)
                                keyPath.set(entityData.keyPath, entity, rowid);

                            return Q.all(queries.insertIndexes(entityData, entity, rowid)
                                .map(function (query) {
                                    return database.run(query, transaction);
                                }))
                                .then(function () {
                                    return entity;
                                });
                        });
                }
            })
        },
        retrieve: function (predicates) {
            return database.all(queries.retrieve(entityData, predicates)).then(function (rows) {
                return _.map(rows, function (row) {
                    var result = JSON.parse(row.content);
                    if (entityData.keyPath)
                        keyPath.set(entityData.keyPath, result, row.__rowid);
                    return result;
                });
            });
        },
        clear: function () {
            return database.run(queries.clear(entityData.name));
        }
    };
}
