var log = require('tribe.logger'),
    Q = require('q'),
    _ = require('underscore');

module.exports = function (database, indexes) {
    return Q.when(createSchema()).then(createIndexes);

    function createSchema() {
        if (database.requiresInitialise) {
            log.debug('eventStore: initialised database structure');
            database.requiresInitialise = false;
            return database.run("create table messages (id int, topic text, envelope text)").then(function () {
                return database.run("create index topic on messages (topic)");
            });
        }
    }

    function createIndexes() {
        if (indexes)
            return database.all("pragma table_info(messages)").then(function (rows) {
                var existing = _.without(_.pluck(rows, 'name'), 'id', 'topic', 'envelope');

                return _.flatten(_.map(indexes, function (index) {
                    if (existing.indexOf(index) === -1) {
                        return [
                            database.run("alter table messages add column " + index + " string"),
                            database.run("create index " + index + " on messages (" + index + ")"),
                            database.run("create index id_" + index + " on messages (id, " + index + ")")
                        ];
                        log.debug('eventStore: created index ' + index);
                    }
                }));
            });
    }
};