suite('tribe.storage.sqlite3.initialise', function () {
    var initialise = require('tribe.storage/sqlite3/initialise'),
        database = require('tribe.storage/sqlite3/database');

    setup(function () {
        database.open(':memory:');
    });

    teardown(database.close);

    test("initialise creates table with entity name and key column", function () {
        return initialise({ name: 'messages', indexes: [], keyPath: 'id' }, database)
            .then(function () {
                return database.get("select * from messages where id = 1");
            });
    });

    // should probably test for creation of actual indexes
    test("initialise with index creates index table", function () {
        return initialise({ name: 'messages', indexes: ['testId'] }, database)
            .then(function () {
                return database.get("select * from messages_testId");
            });
    });

    test("initialise with keyPath index creates index table", function () {
        return initialise({ name: 'messages', indexes: ['test.id'] }, database)
            .then(function () {
                return database.get("select * from messages_test_id");
            });
    });

    test("initialise with multiple keyPath index creates index tables", function () {
        return initialise({ name: 'messages', indexes: [['test.id', 'test2']] }, database)
            .then(function () {
                return database.get("select * from messages_test_id");
            })
            .then(function () {
                return database.get("select * from messages_test2");
            });
    });

    test("columns can be specified multiple times in initialise", function () {
        return initialise({ name: 'messages', indexes: ['testId', ['testId', 'test2Id']] }, database)
            .then(function () {
                return database.get("select * from messages_testId");
            });
    });

    test("initialise with new indexes creates new index tables", function () {
        return initialise({ name: 'messages', indexes: ['testId'] }, database)
            .then(function () {
                return initialise({ name: 'messages', indexes: ['test2Id'] }, database);
            })
            .then(function () {
                return database.get("select * from messages_test2Id");
            });
    });

    test("initialise without keyPath creates __key column", function () {
        return initialise({ name: 'messages', indexes: [] }, database)
            .then(function () {
                return database.get("select * from messages where __key = 1");
            });
    });
});
