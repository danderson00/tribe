(function() {
    ko.bindingHandlers.pane = { init: init, update: update };
    ko.virtualElements.allowedBindings.pane = true;

    function init() {
        return { controlsDescendantBindings: true };
    }

    function update(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        if(element && element.nodeType === 8) {
            // a bit nasty - got to get a child element to get at the node
            var children = $(firstElementChild()).children();
            if(children.length) {
                var node = T.nodeFor(children[0]);
                node.navigate(constructPaneOptions(valueAccessor, allBindingsAccessor));
                return node;
            } else {
                ko.virtualElements.prepend(element, $('<div></div>')[0]);
                return createNode(ko.virtualElements.firstChild(element));
            }
        } else
            return createNode(element);

        function createNode(element) {
            return T.createNode(element, constructPaneOptions(), T.Utils.extractNode(bindingContext), T.Utils.extractContext(bindingContext));
        }

        function constructPaneOptions() {
            return T.Utils.getPaneOptions(ko.utils.unwrapObservable(valueAccessor()), allBindingsAccessor());
        }

        function firstElementChild() {
            var child = ko.virtualElements.firstChild(element);
            return firstElementSibling(child);
            function firstElementSibling(sibling) {
                if(!sibling)
                    return null;

                if(sibling.nodeType === 1)
                    return sibling;

                return firstElementSibling(ko.virtualElements.nextSibling(sibling));
            }
        }
    }
})();
