(function() {
    ko.bindingHandlers.pane = { init: init, update: update };
    ko.virtualElements.allowedBindings.pane = true;

    function init() {
        return { controlsDescendantBindings: true };
    }

    function update(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        if(element && element.nodeType === 8) {
            var child = firstChild(element);
            if(child) {
                // a bit nasty - got to get a child element to get at the node
                var node = T.nodeFor(firstChild(child, true));
                node.navigate(constructPaneOptions(valueAccessor, allBindingsAccessor));
                return node;
            } else {
                ko.virtualElements.prepend(element, $('<div></div>')[0]);
                return createNode(ko.virtualElements.firstChild(element));
            }
        } else
            return createNode(element);

        function createNode(element) {
            return T.createNode(element, constructPaneOptions(), T.Utils.extractNode(bindingContext), T.Utils.extractContext(bindingContext));
        }

        function constructPaneOptions() {
            return T.Utils.getPaneOptions(ko.utils.unwrapObservable(valueAccessor()), allBindingsAccessor());
        }

        function firstChild(target, includeComments) {
            var child = ko.virtualElements.firstChild(target);
            return firstSibling(child);

            function firstSibling(sibling) {
                if(!sibling)
                    return null;

                if(sibling.nodeType === 1 || (includeComments && sibling.nodeType === 8))
                    return sibling;

                return firstSibling(ko.virtualElements.nextSibling(sibling));
            }
        }
    }
})();
