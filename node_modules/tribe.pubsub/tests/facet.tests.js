suite('tribe.pubsub.facet', function () {
    var pubsubModule = require('../pubsub'),
        facetModule = require('../facet'),

        spy, definition, pubsub;

    setup(function () {
        pubsub = new pubsubModule({ sync: true, handleExceptions: false });
        definition = createDefinition();
        spy = sinon.spy();
    });

    test("data passed to pubsub.startFacet are passed to onstart handler", function () {
        expect(2);
        var s = pubsub.startFacet(constructor, 'data');
        function constructor(facet) {
            assert.equal(facet.pubsub.owner, pubsub);
            facet.onstart = function (data) { assert.equal(data, 'data'); };
        }
    });

    test("data passed to lifetime.startFacet are passed to onstart handler", function () {
        expect(2);
        var s = pubsub.createLifetime().startFacet(constructor, 'data');
        function constructor(facet) {
            assert.equal(facet.pubsub.owner, pubsub);
            facet.onstart = function (data) { assert.equal(data, 'data'); };
        }
    });

    test("facet instance is available through instance property", function () {
        var facet = new facetModule(pubsub, constructor);
        expect(facet.instance.value).to.equal('test');
        function constructor() {
            this.value = 'test';
        }
    });

    test("facet can be created with no constructor", function () {
        var facet = new facetModule(pubsub);
        expect(facet.instance.__facet).to.equal(facet);
    });

    test("handlers for topic can be added more than once", function () {
        var facet = new facetModule(pubsub);
        facet.handles('test', spy);
        facet.handles('test', spy);
        facet.start();
        pubsub.publish('test');
        expect(spy.callCount).to.equal(2);
    });

    test("handler is executed with correct arguments when topic is published", function () {
        definition.handles = { 'testTopic': spy };
        var facet = new facetModule(pubsub, definition).start();
        pubsub.publish('testTopic', 'data');

        assert.ok(spy.calledOnce);
        assert.equal(spy.firstCall.args[0], 'data');
        assert.equal(spy.firstCall.args[1].data, 'data');
        assert.equal(spy.firstCall.args[2], facet);
    });

    test("onstart handler is executed when facet is started", function () {
        definition.onstart = spy;
        var facet = new facetModule(pubsub, definition);
        assert.ok(spy.notCalled);
        facet.start();
        assert.ok(spy.calledOnce);
    });

    test("onstart is called with argument passed to start", function () {
        definition.onstart = spy;
        var facet = new facetModule(pubsub, definition).start('arg');
        assert.ok(spy.calledOnce);
        assert.equal(spy.firstCall.args[0], 'arg');
        assert.equal(spy.firstCall.args[1], facet);
    });

    test("onend handler is executed when facet is ended", function () {
        definition.onend = spy;
        var facet = new facetModule(pubsub, definition).start();
        assert.ok(spy.notCalled);
        facet.end();
        assert.ok(spy.calledOnce);
    });

    test("onend handler is called wtih argument passed to end", function () {
        definition.onend = spy;
        var facet = new facetModule(pubsub, definition).start();
        facet.end('arg');
        assert.equal(spy.firstCall.args[0], 'arg');
        assert.equal(spy.firstCall.args[1], facet);
    });

    test("startChild starts child and adds to children", function () {
        var child = createDefinition(spy);
        var facet = new facetModule(pubsub, definition);
        facet.startChild(child);
        assert.ok(spy.calledOnce);
        assert.equal(facet.children.length, 1);
    });

    test("startChild passes data to child start function", function () {
        expect(1);
        var child = function(childFacet, data) {
            childFacet.onstart = function(data) {
                assert.equal(data, 'data');
            };
        };
        var facet = new facetModule(pubsub, definition);
        facet.startChild(child, 'data');
    });

    test("end calls end on any children with data passed", function () {
        var child = createDefinition(null, spy);
        var facet = new facetModule(pubsub, definition);
        facet.startChild(child);
        facet.end('arg');
        assert.ok(spy.calledOnce);
        assert.equal(spy.firstCall.args[0], 'arg');
    });

    test("suspend calls suspend on any children with data passed", function () {
        var child = createDefinition(null, null, spy);
        var facet = new facetModule(pubsub, definition);
        facet.startChild(child);
        facet.suspend('arg');
        assert.ok(spy.calledOnce);
        assert.equal(spy.firstCall.args[0], 'arg');
    });

    test("Facet ends when null handler is executed", function () {
        definition.handles = { 'endTopic': null };
        definition.onend = spy;
        var facet = new facetModule(pubsub, definition).start();
        pubsub.publish('endTopic');
        assert.ok(definition.onend.calledOnce);
    });

    test("Child facet is started when child handler is executed", function () {
        definition.handles = {
            'startChild': {
                'childTopic': spy
            }
        };
        var facet = new facetModule(pubsub, definition).start();
        pubsub.publish('childTopic');
        assert.ok(spy.notCalled);
        pubsub.publish('startChild');
        pubsub.publish('childTopic');
        assert.ok(spy.calledOnce);
    });

    test("Children are ended when parent message is received", function () {
        definition.handles = {
            'startChild': {
                'childTopic': spy
            },
            'parentTopic': function () { }
        };
        var facet = new facetModule(pubsub, definition).start();
        pubsub.publish('startChild');
        pubsub.publish('childTopic');
        pubsub.publish('parentTopic');
        pubsub.publish('childTopic');
        assert.ok(spy.calledOnce);
    });

    test("Children are not ended when parent message is received if endsChildrenExplicitly is set", function () {
        definition.handles = {
            'startChild': {
                'childTopic': spy
            },
            'parentTopic': function () { }
        };
        definition.endsChildrenExplicitly = true;
        var facet = new facetModule(pubsub, definition).start();
        pubsub.publish('startChild');
        pubsub.publish('childTopic');
        pubsub.publish('parentTopic');
        pubsub.publish('childTopic');
        assert.ok(spy.calledTwice);
    });

    test("resume sets data and executes onresume handler", function () {
        definition.onresume = spy;
        var facet = new facetModule(pubsub, definition).resume('test');
        assert.equal(facet.data, 'test');
        assert.ok(spy.calledOnce);
    });

    test("before and after message handlers are executed for each handled message", function () {
        definition.handles = { 'testTopic1': spy, 'testTopic2': spy };
        var facet = new facetModule(pubsub, definition).start();
        facet.beforeMessage = sinon.spy();
        facet.afterMessage = sinon.spy();
        pubsub.publish('testTopic1', 'data');
        pubsub.publish('testTopic2', 'data');
        pubsub.publish('testTopic3', 'data');

        assert.ok(facet.beforeMessage.calledTwice);
        assert.ok(facet.afterMessage.calledTwice);
    });

    test("before and after message handlers are executed when defined in constructor", function () {
        var before = sinon.spy(),
            after = sinon.spy(),
            s = pubsub.startFacet(constructor, 'data');

        pubsub.publish('testTopic1', 'data');
        pubsub.publish('testTopic2', 'data');
        pubsub.publish('testTopic3', 'data');

        assert.ok(before.calledTwice);
        assert.ok(after.calledTwice);

        function constructor(facet) {
            facet.handles({ 'testTopic1': spy, 'testTopic2': spy });
            facet.beforeMessage = before;
            facet.afterMessage = after;
        }
    });

    test("messages published from facet are not published to message bus when replayed", function () {
        var facet = new facetModule(pubsub, constructor).start();
        pubsub.subscribe('test2', spy);
        pubsub.publish('test');
        expect(spy.callCount).to.equal(1);
        facet.replay([{ topic: 'test' }]);
        expect(spy.callCount).to.equal(1);

        function constructor(facet) {
            facet.handles({
                'test': function () {
                    facet.pubsub.publish('test2');
                }
            });
        }
    });

    test("handlers for * have all messages replayed", function () {
        var facet = new facetModule(pubsub),
            spy = sinon.spy();
        facet.handles('*', spy);
        facet.handles('*', spy);
        facet.replay([{ topic: 'test' }, { topic: 'test2' }]);
        expect(spy.callCount).to.equal(4);
    });

    test("dependencies are attached to facet", function () {
        var dependencies = { p1: 1, p2: 'test' },
            facet = new facetModule(pubsub, constructor, null, dependencies);

        function constructor(facet) {
            expect(facet.dependencies).to.equal(dependencies);
        }
    });

    function createDefinition(onstart, onend, onsuspend) {
        return {
            pubsub: pubsub,
            onstart: onstart,
            onend: onend,
            onsuspend: onsuspend
        };
    }
});
