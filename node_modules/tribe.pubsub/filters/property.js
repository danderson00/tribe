var utils = require('../utils');

module.exports = function (topic) {
    var properties = {},
        tokens = {};

    return {
        add: function (handler, token, options) {
            if (!properties[options.property])
                properties[options.property] = {};

            var property = properties[options.property];
            if (!property[options.value])
                property[options.value] = {};

            property[options.value][token] = handler;
            tokens[token] = options;
        },
        remove: function (token) {
            var options = tokens[token];
            if (options) {
                delete properties[options.property][options.value][token];
                delete tokens[token];
            }
        },
        get: function (envelope) {
            if (!envelope.data)
                return [];

            var handlers = [];

            for (var property in properties)
                if (properties.hasOwnProperty(property)) {
                    var value = utils.evaluateKeyPath(property, envelope);
                    if(value !== undefined)
                        handlers = handlers.concat(utils.values(properties[property][value]));
                }

            return handlers;
        }
    };
};