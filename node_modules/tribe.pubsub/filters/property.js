var utils = require('../utils'),
    expressions = require('tribe.expressions');

// this filter uses tribe.expressions and only supports the '=' expression

module.exports = function (topic) {
    var properties = {},
        tokens = {};

    return {
        add: function (handler, token, expression) {
            if (!properties[expression.p])
                properties[expression.p] = {};

            var property = properties[expression.p];
            if (!property[expression.v])
                property[expression.v] = {};

            property[expression.v][token] = handler;
            tokens[token] = expression;
        },
        remove: function (token) {
            var expression = tokens[token];
            if (expression) {
                delete properties[expression.p][expression.v][token];
                delete tokens[token];
            }
        },
        get: function (envelope) {
            if (!envelope.data)
                return [];

            var handlers = [];

            for (var property in properties)
                if (properties.hasOwnProperty(property)) {
                    var value = expressions.evaluateKeyPath(property, envelope);
                    if(value !== undefined)
                        handlers = handlers.concat(utils.values(properties[property][value]));
                }

            return handlers;
        }
    };
};