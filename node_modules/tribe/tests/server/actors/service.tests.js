suite('tribe.actors.service.integration', function () {
    var service = require('tribe/actors/service'),
        actors = require('tribe/actors'),
        eventStore = require('tribe/eventStore'),
        Q = require('q');

    test("service returns messages saved to event store", function () {
        actors.register('serviceTest', function (actor) {
            actor.mapsMessagePropertyToId('testId');
        });

        return eventStore.initialise({ name: 'sqlite3', filename: ':memory:' }, ['testId'])
            .then(function () {
                return Q.all([
                    eventStore.store({ topic: 'test', data: { testId: 1 } }),
                    eventStore.store({ topic: 'test', data: { testId: 2 } }),
                    eventStore.store({ topic: 'test', data: { testId: 1 } })
                ]);
        }).then(function () {
            return service({ name: 'serviceTest', id: 1 });
        }).then(function (result) {
            expect(result.envelopes.length).to.equal(2);
            expect(result.envelopes[0]).to.deep.equal({ topic: 'test', data: { testId: 1 }, id: 1 });
            expect(result.envelopes[1]).to.deep.equal({ topic: 'test', data: { testId: 1 }, id: 3 });
        });
    });
});