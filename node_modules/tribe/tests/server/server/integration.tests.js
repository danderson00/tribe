suite('tribe.server.integration', function () {
    test("facets", function () {
        var facets = require('tribe/facets'),
            pubsub = require('tribe.pubsub').createLifetime(),
            storage = require('tribe/storage'),

            message = sinon.spy(), emit = sinon.spy(), ack = sinon.spy(),
            context = { pubsub: pubsub, socket: { emit: emit }, ack: ack, clientId: 'id' };

        pubsub.owner.sync = true;

        facets.register('operations.facet', function (facet) {
            facet.isDistributed();
            facet.handles({
                'message': message,
            });
            facet.isScopedTo('p1', 'p2');
        });

        return storage.initialise([{ name: 'messages', indexes: facets.indexes().concat(['topic']) }], { type: 'sqlite3', filename: ':memory:' })
            .then(function () {
                var facetOperation = require('tribe/server/operations/facet'),
                    messageOperation = require('tribe/server/operations/message');

                return messageOperation({ topic: 'message', data: { p1: 1, p2: 2 } }, context)
                    .then(function () {
                        expect(ack.callCount).to.equal(1);
                        return facetOperation({ facet: 'operations.facet', scope: { p1: 1, p2: 2 } }, context);
                    })
                    .then(function () {
                        expect(ack.callCount).to.equal(2);
                        expect(ack.secondCall.args[0].envelopes.length).to.equal(1);

                        pubsub.publish('message', { p1: 1, p2: 2 });
                        pubsub.publish('message', { p1: 2, p2: 2 });

                        expect(emit.callCount).to.equal(1);

                        pubsub.end();
                    });
            });
    });
});
