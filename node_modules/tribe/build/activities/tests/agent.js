var build = require('tribe/build'),
    utils = require('tribe/utilities'),
    memory = require('tribe/server/modules/memory');

build.activities.register('tests.agent', function () {
    return {
        render: function (context) {
            build.blocks('renderTemplate')('tests.agent').to('tests.agent.html', 'tests.agent')(context);
            return build.blocks('browserify')('tests', configure).to('tests.agent.js', 'tests.agent')(context);
        },
        output: function (context) {
            memory.register('tests.agent', context['tests.agent']);
        }
    };
});

function configure(b, files) {
    b.exclude('./lib-cov/mocha');
    b.ignore(require.resolve('mocha/lib/reporters/html-cov'));

    b.transform(utils.streams.throughTransform(function (source, file) {
        return "require('tribe/test').register(" + utils.script.toString(source) + ");";
    }, files));
}
