var build = require('tribe/build'),
    options = require('tribe/options'),
    utils = require('tribe/utilities'),
    memory = require('tribe/server/modules/memory');

build.activities.register('tests.agent', function () {
    return {
        render: function (context) {
            build.blocks('renderTemplate')('tests.agent', { options: browserOptions() }).to('tests.agent.html', 'tests.agent')(context);
            return build.blocks('browserify')('tests', configure).to('tests.agent.js', 'tests.agent')(context);
        },
        output: function (context) {
            memory.register('tests.agent', context['tests.agent']);
        }
    };
});

function configure(b, files) {
    b.exclude('./lib-cov/mocha');
    b.ignore('./html-cov');
    b.require('mocha/lib/reporters/dot', { expose: './reporters/dot' });

    b.add('tribe/client/PubSub.extensions');
    b.require('tribe.pubsub');
    b.require('tribe/test/mocha/browser', { expose: 'tribe/test' });
    b.require('tribe/options.browser', { expose: 'tribe/options' });

    b.transform(utils.streams.throughTransform(function (source, file) {
        return "require('tribe/test').register(" + utils.script.toString(source) + ");";
    }, files));
}

function browserOptions() {
    return JSON.stringify({
        test: options.test
    });
}