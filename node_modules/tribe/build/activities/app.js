var build = require('tribe/build'),
    utils = require('tribe/utilities'),
    through = require('through'),
    _ = require('underscore');

build.activities.register('app', function () {
    return {
        render: build.blocks('browserify')('js', configure).to('app.js')
    };
});

function configure(b, files) {
    b.require(require.resolve('tribe/client'), { expose: 'tribe' });
    b.transform(setScriptEnvironment);

    function setScriptEnvironment(path) {
        var data = '';
        return through(write, end);

        function write(buf) { data += buf; }
        function end() {
            var file = _.findWhere(files, { path: path });
            if (file) this.queue("T.scriptEnvironment = { resourcePath: '" + file.resourcePath + "' };\n");
            this.queue(utils.files.stripBOM(data));
            this.queue(null);
        }
    }
}
