var utils = require('tribe/utilities'),
    options = require('tribe/options'),
    log = require('tribe/logger'),
    browserify = require('browserify'),
    path = require('path'),
    fs = require('fs'),
    Q = require('q'),
    _ = require('underscore');

module.exports = function (property, configCallback, browserifyOptions) {
    // pass args in any order
    var args = utils.arguments(arguments);
    configCallback = args.func;
    property = args.string;
    browserifyOptions = args.object;

    return {
        to: function (targetPath, targetProperty) {
            targetProperty = targetProperty || 'output';

            return function (context) {
                var b = browserify(),
                    q = Q.defer(),
                    content;

                try {
                    if (configCallback) configCallback(b, context[property], context);

                    _.each(context[property], function (file) {
                        b.add(file.path);
                    });

                    var readStream = b.bundle(_.extend({ debug: options.debug }, browserifyOptions)),
                        content = '';

                    readStream.on('data', function (data) {
                        content += data;
                    });

                    readStream.on('end', function () {
                        context[targetProperty] = context[targetProperty] || {};
                        context[targetProperty][targetPath] = content;
                        q.resolve(content);
                    });

                    readStream.on('error', function (error) {
                        log.error('Failed to browserify \'' + property + '\'', error);
                    });
                } catch (ex) {
                    q.reject(ex);
                }
                
                return q.promise;
            };
        }
    };
};
