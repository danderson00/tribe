suite('tribe.browser.integration.flow.startChild', function () {
    test("publishing messages triggers starting children", function (done) {
        var pubsub = require('tribe.pubsub'),
            node = T.appendNode('body', { path: '/tests/childFlow', pubsub: pubsub })

        T.Utils.contextFor($('body div div')).renderOperation.promise.then(function () {
            // navigation will occur synchronously in this case (no transition)
            expect($('span').text()).to.equal('two')
            pubsub.publish('topic')

            // ok this is nasty. The flow binding handler is broken, it doesn't add its token to the renderOperation properly
            // just hacking it in and getting it working for now
            setTimeout(function () {
                expect($('span').text()).to.equal('four')
                pubsub.publish('childTopic')

                setTimeout(function () {
                    expect($('span').text()).to.equal('five')
                    pubsub.publish('topic2')

                    setTimeout(function () {
                        expect($('span').text()).to.equal('three')
                        done()
                    }, 20)
                }, 20)
            }, 20)
        })
    })
})
