#! /usr/bin/env node

var optimist = require("optimist");
var args = optimist
    .usage("$0 [options]")
    .describe("help", "Show command line usage options")
    .describe("run", "Run tests in command line mode")
    .describe("interface", 'Mocha test API to use ("bdd", "tdd", "exports", etc.)')
    .describe("testPath", "Path to test files")
    .describe("sourcePath", "Path to watch for file changes")
    .describe("filter", "Regular expression files must match to be included")
    .describe("debugPort", "Port to use for debugging")
    .describe("inspectorPort", "Port to expose node-inspector on (if installed)")
	.describe("reporter", "Mocha test reporter to use when running in command line mode")
	.describe("mocha", "Use mocha defaults, i.e. tests from tests/*.js and bdd interface")
	.describe("system", "Run system tests")
	.alias("help", "h")
	.alias("help", "?")
	.alias("run", "r")
    .alias("interface", "i")
	.alias("testPath", "p")
	.alias("sourcePath", "s")
    .alias("filter", "f")
	.alias("mocha", "m")
    .default("filter", "\\.tests\\.js$")
    .default("debugPort", "5859")
    .default("inspectorPort", "8081")
    .default("reporter", "dot")
    .default("interface", "tdd")
    .wrap(80)
    .argv;

if (args.help) {
    console.log(optimist.help());
    return;
}

if (args.mocha) {
	args.testPath = "test";
	args.filter = "\\.js$";
	args.interface = "bdd";
}

var tribe = require('tribe'),
	options = require('tribe/options'),
	path = require('path'),
	modulePath = path.resolve(__dirname, '..');

if(args.system)
	options.testPaths = [path.resolve(options.modulePath, 'tests/server'), path.resolve(modulePath, 'tests')];
else
	options.testPaths = [args.testPath || process.cwd()];
options.appName = 'test-studio';
options.basePath = modulePath; //.substring(0, modulePath.lastIndexOf(path.sep) + 1);
options.test.sourcePath = args.sourcePath || process.cwd();
options.test.debugPort = args.debugPort;
options.test.fileFilter = args.filter;
options.test.mocha.ui = args.interface;
options.inspectorPort = args.inspectorPort;
options.debug = true;

if(args.run) {
	options.test.mocha.reporter = args.reporter;
	require('../run');
} else {
	tribe.start();
}
