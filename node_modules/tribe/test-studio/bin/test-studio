#! /usr/bin/env node

var optimist = require('optimist'),
	path = require('path'),
	modules = require('tribe/server/modules'),

	args = optimist
		.usage("$0 [options]")
		.describe("help", "Show command line usage options")
		.describe("run", "Run tests in command line mode")
		.describe("interface", 'Mocha test API to use ("bdd", "tdd", "exports", etc.)')
		.describe("testPath", "Path to test files")
		.describe("sourcePath", "Path to watch for file changes")
		.describe("scriptPath", "Path containing files to load for browser tests, relative to cwd")
		.describe("filter", "Regular expression files must match to be included")
		.describe("debugPort", "Port to use for debugging")
		.describe("inspectorPort", "Port to expose node-inspector on (if installed)")
		.describe("reporter", "Mocha test reporter to use when running in command line mode")
		.describe("mocha", "Use mocha defaults, i.e. tests from test/*.js and bdd interface")
		.describe("browser", "Configure for browser testing, i.e. tests from tests/*.js and scripts from scripts/*.js")
		.describe("system", "Run system tests")
		.alias("help", "h")
		.alias("help", "?")
		.alias("run", "r")
		.alias("interface", "i")
		.alias("testPath", "p")
		.alias("sourcePath", "s")
		.alias("filter", "f")
		.alias("mocha", "m")
		.default("filter", "\\.tests\\.js$")
		.default("debugPort", "5859")
		.default("inspectorPort", "8081")
		.default("reporter", "dot")
		.default("interface", "tdd")
		.wrap(80)
		.argv;

if (args.help) {
    console.log(optimist.help());
    return;
}

if (args.mocha) {
	args.testPath = "test";
	args.filter = "\\.js$";
	args.interface = "bdd";
}

if (args.browser) {
	args.testPath = "tests";
	args.filter = "\\.js$";
	args.scriptPath = "scripts";
}

var tribe = require('tribe'),
	options = require('tribe/options'),
	path = require('path'),
	modulePath;
	
try {
	modulePath = require.resolve('test-studio/server');
} catch(ex) {
	modulePath = require.resolve('tribe/test-studio/server');	
}
modulePath = modulePath.substring(0, modulePath.lastIndexOf(path.sep) + 1);

if(args.system)
	options.testPaths = [path.resolve(options.modulePath, 'tests/server'), path.resolve(modulePath, 'tests')];
else
	options.testPaths = [args.testPath || process.cwd()];

if(args.scriptPath)
	options.build.tasks.push({ activity: 'dependencies', options: { path: path.resolve(process.cwd(), args.scriptPath) } });

options.appName = 'test-studio';
options.basePath = modulePath;
options.test.sourcePath = args.sourcePath || process.cwd();
options.test.debugPort = args.debugPort;
options.test.fileFilter = args.filter;
options.test.scriptFiles = (args.scriptFile && args.scriptFile.constructor === Array) ? args.scriptFile : [args.scriptFile];
options.test.mocha.ui = args.interface;
options.inspectorPort = args.inspectorPort;
options.debug = true;

options.builds = [
    {
        name: 'app',
        phases: ['prepare', 'render', 'output', 'server'],
        path: modulePath,
        tasks: [
            { activity: 'app' },
            { activity: 'panes', options: { path: 'panes' } },
            { activity: 'resources', options: { path: 'actors' } },
        ]
    }
];

options.server.modules = [
    modules.fs('/dependencies/knockout', path.resolve(options.modulePath, 'node_modules/knockout/build/output')),
    modules.fs('/dependencies/jquery', path.resolve(options.modulePath, 'node_modules/jquery/dist')),
    modules.fs('/dependencies/socket.io', path.resolve(options.modulePath, 'node_modules/socket.io-client')),
    modules.fs('/dependencies/composite', path.resolve(options.modulePath, 'node_modules/tribe.composite/Build')),

	modules.fs('/images', path.resolve(modulePath, 'images')),
    modules.memory.mapFile('/', 'app', 'app.htm'),
    modules.memory('/', 'app')
];

if(args.run) {
	options.test.mocha.reporter = args.reporter;
	require('../run');
} else {
	tribe.start();
}
