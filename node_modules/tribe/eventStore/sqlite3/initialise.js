var log = require('tribe/logger'),
    _ = require('underscore');

module.exports = function (database, indexes) {
    return database.serialise(function (db, fail) {
        if (database.requiresInitialise) {
            db.exec("create table messages (id int, topic text, envelope text)", fail);
            log.debug('eventStore: initialised database structure');
            database.requiresInitialise = false;
        }

        if (indexes)
            db.all("pragma table_info(messages)", function (err, rows) {
                if (fail(err)) return;

                return database.serialise(function (db, fail) {
                    var existing = _.without(_.pluck(rows, 'name'), 'id', 'topic', 'envelope');

                    _.each(indexes, function (index) {
                        if (existing.indexOf(index) === -1) {
                            db.exec("alter table messages add column " + index + " string", fail);
                            db.exec("create index " + index + " on messages (" + index + ")", fail);
                            db.exec("create index id_" + index + " on messages (id, " + index + ")", fail);
                            log.debug('eventStore: created index ' + index);
                        }
                    });
                });
            });
    });
};