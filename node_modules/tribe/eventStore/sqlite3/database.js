var initialise = require('./initialise'),
    Q = require('q');

var api = module.exports = {
    initialise: function (indexes) {
        return initialise(api, indexes);
    },
    serialise: function (callback) {
        var deferred = Q.defer();

        api.db.serialize(function () {
            var result = callback(api.db, rejectOnError);
            api.db.wait(function () {
                // give other database operation callbacks a chance to complete before resolving the promise
                setTimeout(function () {
                    try {
                        Q.when(result).then(deferred.resolve);
                    } catch (ex) {
                        rejectOnError(ex);
                    }
                });
            });
        });

        return deferred.promise;

        function rejectOnError(err) {
            if (err) deferred.reject(err);
            return err;
        }
    },
    close: function () {
        api.db && api.db.close();
        delete api.db;
    }
};
