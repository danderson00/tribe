var pubsub = require('tribe.pubsub'),
    options = require('tribe/options'),
    script = require('tribe/utilities/script'),
    runner = require('./runner'),
    overrides = require('./overrides'),
    construct = require('./construct'),
    Mocha = require('mocha'),
    chai = require('chai'),
    sinon = require('sinon'),
    useragent = require('tribe/utilities/ua-parser'),
    _ = require('underscore'),
    scripts = {},
    mocha;

module.exports = {
    register: function (path, script) {
        scripts[path] = script;
    },
    initialise: function () {
        var browser = useragent(window.navigator.userAgent).browser;
        options.test.agent = browser.name + ' ' + browser.version;
        mocha = new Mocha(options.test.mocha);
        _.each(scripts, load);
    },
    run: function (tests) {
        return runner.run(tests ? construct.suite(mocha, tests) : mocha.suite);
    }
};

pubsub.sync = true;

pubsub.subscribe('test.run', module.exports.run);

pubsub.subscribe('test.start', function (test) {
    if (test.agent === options.test.agent)
        document.body.innerHTML = '';
});

pubsub.subscribe('test.loaded', function (test) {
    // no point adding this until the app is rebuilt on file change
});

function load(source, path) {
    var context = { expect: chai.expect, assert: chai.assert, sinon: sinon };

    // load up context object with mocha interface
    mocha.suite.emit('pre-require', context, path, mocha);

    script.evalInContext(source, context);
}

// mocha expects the process object to have a removeListener function
process.removeListener = process.removeListener || process.off;