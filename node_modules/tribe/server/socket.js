module.exports = {
    start: function (server) {
        var server = require('./http').server,
            io = require('socket.io').listen(server),
            log = require('tribe/logger'),
            pubsub = require('tribe.pubsub'),
            eventStore = require('tribe/eventStore'),
            channels = require('tribe/server/channels'),
            options = require('tribe/options');

        module.exports.io = io;

        io.sockets.on('connection', function (socket) {
            var address = socket.handshake.address;
            log.debug('Client connected - ' + address.address + ':' + address.port);
            
            socket.on('message', function (envelope, ack) {
                eventStore
                    .store(envelope)
                    .then(function (id) {
                        ack(id);
                        envelope.__origin = socket;
                        pubsub.publish(envelope);
                    })
                    .fail(function (err) {
                        ack(null, err);
                    });
            });
            
            socket.on('join', function (channel) {
                log.debug('Client joined channel ' + channel + ' - ' + address.address + ':' + address.port);
                channels.join(channel, socket);
            });

            socket.on('disconnect', function () {
                log.debug('Client disconnected - ' + address.address + ':' + address.port);
                channels.leaveAll(socket);
            });
        });

        log.info('Accepting socket connections');
    }
};