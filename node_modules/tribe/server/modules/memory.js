var collections = {};

var api = module.exports = function (path, collection) {
    return function (app) {
        app.use(path, function (req, res) {
            var folder = collections[collection],
                filename = req.path.substring(req.path.lastIndexOf('/') + 1);

            if (folder && folder[filename])
                res.type(req.path.substring(req.path.lastIndexOf('.'))).send(folder[filename]).end();
            else
                res.status(404).send('Not found.').end();
        });
    };
};

api.mapFile = function (path, collectionName, file) {
    return function (app) {
        app.all(path, function (req, res) {
            var extensionStart = file.lastIndexOf('.'),
                mobileFile = file.substring(0, extensionStart) + '.mobile' + file.substring(extensionStart),
                collection = collections[collectionName],
                content;

            if (collection) {
                if (collection[mobileFile] && (req.useragent.isMobile || req.query.m !== undefined))
                    content = collection[mobileFile];
                else
                    content = collection[file];
            }

            if (content)
                res.type(file.substring(file.lastIndexOf('.'))).send(content).end();
            else
                res.status(404).send('Not found.').end();
        });
    };
};

api.register = function (name, files) {
    collections[name] = files;
};

api.collections = collections;