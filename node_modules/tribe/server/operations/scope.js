var eventStore = require('tribe/storage').entity('messages'),
    facets = require('tribe/facets'),
    expressions = require('tribe.expressions'),
    log = require('tribe.logger'),
    _ = require('underscore');

// we need to attach subscriptions to the connection so they can be released if we are disconnected

module.exports = function (options, context) {
    // authorise!

    log.silly("Client requested scope " + JSON.stringify(options.scope));

    var expression = expressions.create.fromScope(options.scope);

    var token = subscribe('*', expression);

    if (options.since)
        expression = expression.concat({ p: 'seq', o: '>', v: options.since });

    return returnMessages(expression, token);

    function subscribe(topics, expression) {
        return context.pubsub.subscribe(topics, function (data, envelope) {
            if (shouldSendToClient()) {
                context.socket.emit('message', envelope);
                envelope.addToBroadcastList && envelope.addToBroadcastList(context.clientId);
            }

            function shouldSendToClient() {
                return (envelope.sourceId !== context.clientId || envelope.echo) 
                    && (!envelope.hasBeenBroadcastTo || !envelope.hasBeenBroadcastTo(context.clientId)); 
            }
        }, expression);
    }

    function returnMessages(expression, token) {
        return eventStore.retrieve(expression)
            .then(function (envelopes) {
                context.ack({ envelopes: envelopes, token: token });
            })
            .fail(function (err) {
                log.error('Failed to retrieve facet messages', err);
                context.ack(null, err);
            });
    }
}
