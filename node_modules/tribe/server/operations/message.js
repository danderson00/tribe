var log = require('tribe.logger'),
    messageThrottle = require('../messageThrottle'),
    messages = require('tribe/storage').entity('messages');

module.exports = function (envelope, context) {
    log.silly("Received message with topic " + envelope.topic + " from " + context.clientId);
    envelope.sourceId = context.clientId;
    envelope.serverTime = new Date();
    messageThrottle.annotateEnvelope(envelope);
    return messages
        .store(envelope)
        .then(function (storedEnvelope) {
            context.ack(storedEnvelope);
            context.pubsub.publish(storedEnvelope);
        })
        .fail(function (err) {
            log.error('Failed to store message', err);
            context.ack(null, err);
        });
};