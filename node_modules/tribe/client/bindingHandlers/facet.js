ko.virtualElements.allowedBindings.facet = true;
ï»¿ko.bindingHandlers.facet = {
    init: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        var node = T.Utils.extractNode(bindingContext),
            context = T.Utils.extractContext(bindingContext),
            facetPath = valueAccessor(),
            pubsub = node.pane.pubsub,
            token = {};

        if(facetPath) {
            context.renderOperation.add(token);

            pubsub.obtainFacet(facetPath, allBindingsAccessor().scope).then(function (facet) {
                ko.applyBindingsToDescendants(bindingContext.extend(facet), element);

                T.nodeFor(element).pane.is.disposed.then(function () {
                    facet.__facet.release();
                });

                context.renderOperation.complete(token);
            }).fail(function (err) {
                T.logger.error('Failed to retrieve facet', err);
            });
        }

        return { controlsDescendantBindings: true };
    }
};
