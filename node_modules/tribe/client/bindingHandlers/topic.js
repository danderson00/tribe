var actorModule = require('tribe.pubsub/actor');

ko.bindingHandlers.topic = {
    init: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        var pane = T.Utils.extractNode(bindingContext).pane,
            context = T.Utils.extractContext(bindingContext),
            actor = paneActor(),
            topic = valueAccessor(),

            // in future, we want to attach this to the actor so it is serialised with snapshots
            // this will also be different when we start to handle aggregates like 'sum'
            list = ko.observableArray();

        actor.handles(valueAccessor(), function (data) {
            list.push(data);
            executeForeach('update');
        });

        executeForeach('init');

        function paneActor() {
            if(!pane.__generatedActor) {
                pane.__generatedActor = new actorModule(pane.pubsub, constructor);
                // this blocks renderComplete until completed
                context.renderOperation.add(pane.__generatedActor);
            }
            return pane.__generatedActor;
        }

        function constructor(actor) {
            actor.isDistributed();
        }

        function executeForeach(name) {
            ko.bindingHandlers.foreach[name](element, function () { return list; }, function () { return {} }, viewModel, bindingContext);
        }
    }
}
