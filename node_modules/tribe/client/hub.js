var pubsub = require('tribe.pubsub'),
    socket;

var hub = module.exports = {
    connect: function () {
        socket = io.connect();

        socket.on('message', function (envelope) {
            envelope.origin = 'server';
            pubsub.publish(envelope);
        });
    },

    publish: function(envelope) {
        if (!socket) hub.connect();

        if(envelope.origin !== 'server')
            socket.emit('message', envelope, function () {
                //console.log('message acknowledged');
            });
    },

    subscribe: function (options) {
        if (!socket) hub.connect();

        // don't know why this timeout is required... only 'message' events are queued using emit??
        setTimeout(function () {
            socket.emit('subscribe', options, function (envelopes, err) {
                //console.log('subscription successful');
            });
        });
    }
};