var gateway = require('./gateway'),
    facets = require('tribe/facets'),
    scopes = require('./scopes'),
    pubsub = require('tribe.pubsub/pubsub'),
    utils = require('tribe.pubsub/utils'),
    lifetime = require('tribe.pubsub/lifetime'),
    expressions = require('tribe.expressions'),
    Q = require('q')

pubsub.prototype.obtainFacet = function (path, scope) {
    var self = this,
        definition = facets.definition(path),
        facet

    if (!definition)
        throw new Error("Requested facet '" + path + "' has not been registered")

    if(scope && typeof scope !== "object")
        scope = createScopeFromScalar(definition.scope, scope)

    scope = utils.extend({}, self.scope, scope)

    return loadDependencies(this, definition, scope)
        .then(function (dependencies) {
            facet = facets.create(self, path, scope, dependencies)

            if (facet.metadata.isDistributed)
                return self.syncFacet(facet, scope)

            return facet.start().instance;
        })
};

function createScopeFromScalar(definition, scopeValue) {
    var scope = {};
    for(var i = 0, l = definition.length; i < l; i++)
        scope[definition[i]] = scopeValue;
    return scope;
}

function loadDependencies(pubsub, definition, scope) {
    var dependencies = {};

    if (!definition.dependencies) return Q();

    var promises = $.map(definition.dependencies, function (dependency) {
        return pubsub.obtainFacet(dependency, scope).then(function (instance) {
            dependencies[dependency] = instance;
        });
    });

    return Q.all(promises).then(function () {
        return dependencies;
    });
}

pubsub.prototype.syncFacet = function (facet, scope) {
    scope = utils.extend({}, this.scope, scope)
    return scopes.request(scope)
        .then(function (data) {
            if(data && data.envelopes)
                facet.replay(data.envelopes);
            return facet.start().instance;
        });
};

pubsub.prototype.releaseFacet = function (facetOrScope) {
    var scope = facetOrScope.__facet
        ? facetOrScope.__facet.scope
        : (facetOrScope.hasOwnProperty('scope') ? facetOrScope.scope : facetOrScope)
    scope = utils.extend({}, this.scope, scope)
    scopes.release(scope);
};

lifetime.prototype.obtainFacet = pubsub.prototype.obtainFacet;
lifetime.prototype.syncFacet = pubsub.prototype.syncFacet;
lifetime.prototype.releaseFacet = pubsub.prototype.releaseFacet;


// deprecated. only used by test-studio
pubsub.prototype.startFacet = function (path, scope, options) {
    options = options || {};

    var facet = facets.create(this, path, scope);

    if (facet.metadata.isDistributed && options.local !== true)
        attachToHub(path, facet, false);

    return facet.start(options.data);

    function attachToHub(path, facet, replay) {
        facet.pubsub.subscribe(facet.topics(), function (message, envelope) {
            gateway.publish(envelope);
        }, facet.metadata.expression);
        return gateway.facet({ facet: path, scope: facet.scope, replay: replay });
    }
};

lifetime.prototype.startFacet = pubsub.prototype.startFacet;
