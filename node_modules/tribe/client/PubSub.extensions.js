var hub = require('./hub'),
    serializer = require('tribe/utilities/serializer'),
    pubsub = require('tribe.pubsub');

Tribe.PubSub.prototype.startActor = function (id, path, data) {
    if (path.charAt(0) !== '/')
        path = '/' + path;

    var actor = new Tribe.PubSub.Actor(this, actorDefinition(path));

    if (actor.runsOnServer) {
        attachToHub(actor);
        hub.startActor(path, id, data);
    }

    return actor.start(data);
};

Tribe.PubSub.prototype.joinActor = function (id, path, data) {
    var deferred = $.Deferred();
    var self = this;
    $.when($.get('Data/' + id + '/' + id))
        .done(function (data) {
            var actor = new Tribe.PubSub.Actor(self, actorDefinition(data.path));
            actor.id = id;
            actor.join(serializer.deserialize(data.data));
            attachToHub(actor);
            deferred.resolve(actor);
        })
        .fail(function (reason) {
            if (reason.status === 404 && path) {
                var actor = self.startActor(id, path, data);
                deferred.resolve(actor);
            }
            else deferred.reject(reason);

        });
    return deferred;
};

function actorDefinition(path) {
    return T.context().actors[path].constructor;
}

// need to also be able to detach
function attachToHub(actor) {
    hub.join(actor.id);
    actor.pubsub.subscribe(actor.topics, function (message, envelope) {
        envelope.actorId = actor.id;
        hub.publish(envelope);
    });
}

Tribe.PubSub.Lifetime.prototype.startActor = Tribe.PubSub.prototype.startActor;
Tribe.PubSub.Lifetime.prototype.joinActor = Tribe.PubSub.prototype.joinActor;
Tribe.PubSub.Channel.prototype.startActor = Tribe.PubSub.prototype.startActor;
Tribe.PubSub.Channel.prototype.joinActor = Tribe.PubSub.prototype.joinActor;

Tribe.PubSub.Channel.prototype.connect = function (topics) {
    var self = this;

    hub.join(this.id);
    this.subscribe(topics || '*', function(data, envelope) {
        hub.publish(envelope);
    });

    var end = this.end;
    this.end = function() {
        hub.leave(self.channelId);
        end();
    };

    return this;
};
