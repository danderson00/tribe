var pubsub = require('tribe.pubsub'),
    modules = require('tribe/server/modules'),
    _ = require('underscore'),
    path = require('path');

pubsub.options.sync = true;
pubsub.options.handleExceptions = false;

var options = module.exports = {
    apply: function (optionsToApply) {
        return _.extend(options, optionsToApply);
    },

    port: 1678,
    appName: 'Tribe',
    basePath: basePath(),
    dataPath: basePath() + 'Data/',
    modulePath: modulePath(),
    testPaths: testPaths(),
    browserTestPaths: browserTestPaths(),
    debug: debugMode(),
    debugPort: process.debugPort,
    inspectorPort: 8080,
    childProcess: false,
    watcherDelay: 200,
    build: {
        phases: ['prepare', 'render', 'output', 'server'],
        tasks: [
            { activity: 'app' },
            { activity: 'tests.agent' },
            { activity: 'dependencies', options: { path: 'dependencies' } },
            { activity: 'panes', options: { path: 'panes' } },
            { activity: 'resources', options: { path: 'sagas' } },
            { activity: 'resources', options: { path: 'handlers' } },
            { activity: 'resources', options: { path: 'services' } },
            { activity: 'scripts', options: { path: 'scripts' } },
            { activity: 'styles', options: { path: 'styles' } },
            { activity: 'templates', options: { path: 'templates' } },            
            { activity: 'tests.browser', options: { path: 'tests/client' } } // see below
        ]
    },
    server: {
        modules: [
            // should probably just map these as virtual folders
            modules.memory.mapFile('/', 'app', 'app.htm'),
            modules.memory.mapFile('/app.css', 'app', 'app.css'),
            modules.memory.mapFile('/app.js', 'app', 'app.js'),
            modules.memory.mapFile('/tests.agent.js', 'tests.agent', 'tests.agent.js'),
            modules.memory.mapFile('/tests.agent.html', 'tests.agent', 'tests.agent.html'),
            modules.memory('/modules', 'modules'),
            modules.fs('/images'),
        ]
    },
    test: {
        framework: 'mocha',
        mocha: {
            ui: 'tdd'
        },
        debugPort: 5859,
        restartThrottle: 200,
        fileFilter: /\.tests\.js$/,
        browser: {
            runOnServer: false
        }
    }
};

function basePath() {
    var basePath = process.argv[1];
    return basePath.substr(0, basePath.lastIndexOf(path.sep) + 1);
}

function modulePath() {
    return __dirname;
}

function debugMode() {
    return process.execArgv.indexOf('--debug') > -1 || process.execArgv.indexOf('--debug-brk') > -1;
}

// these will be replaced by the config system when implemented
function testPaths() {
    return [
        path.resolve(__dirname, 'tests/server/'),
        basePath() + 'tests/'
    ];
}

function browserTestPaths() {
    return [
        basePath() + 'tests/client'
    ];
}
