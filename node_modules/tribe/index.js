var log = require('tribe/logger'),
    Q = require('q'),
    _ = require('underscore');

// this is less than ideal. It allows code running on the server side like actors to use knockout without requiring it or even installing it
// possibly will be replaced by passing knockout to modules using a custom module loader like tests are now
ko = require('knockout');

module.exports = {
    // server
    start: function (options) {
        options = require('tribe/options').apply(options);

        if (options.debug)
            require('tribe/process/inspector').start(options.inspectorPort);

        require('tribe/test').initialise(true);

        Q.all(_.map(options.builds, function (build) {
            return require('tribe/build')
                .configure(build)
                .watch()
                .execute();
        }))
        .then(function () {
            return require('tribe/eventStore')
                .initialise(options.eventStore, require('tribe/actors').indexes());
        })
        .then(function () {
            require('tribe/services')
                .registerModules(options.services);

            require('tribe/server')
                .configure(options.server)
                .start();
        })
        .fail(function (err) {
            log.error('Failed to start server', err);
            process.exit(1);
        });
    },

    // common
    register: require('tribe/register'),
    pubsub: require('tribe.pubsub'),
    options: require('tribe/options')
};