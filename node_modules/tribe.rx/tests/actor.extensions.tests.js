var Actor = require('tribe.pubsub/actor'),
    Pubsub = require('tribe.pubsub/pubsub'),
    pubsub;

require('../actor.extensions')

setup(function () {
    pubsub = new Pubsub({ sync: true, handleExceptions: false });
});

suite('tribe.rx.actor.extensions.messages', function () {
    test("property is lazily evaluated", function () {
        var actor = new Actor(pubsub)
        expect(Object.keys(actor.handlers).length).to.equal(0)
        var observable = actor.messages
        observable.subscribe(function () {})
        expect(Object.keys(actor.handlers).length).to.equal(1)
    })

    test("property is cached", function () {
        var actor = new Actor(pubsub),
            messages1 = actor.messages,
            messages2 = actor.messages
        expect(messages1).to.equal(messages2)
    })

    test("returns rx observable linked to actor pubsub", function () {
        var actor = new Actor(pubsub),
            observable = actor.messages,
            spy = sinon.spy()

        observable.where(function (message) { return message[0] === 'a' }).subscribe(spy)
        actor.start()
        pubsub.publish('topic', 'aa')
        pubsub.publish('topic', 'ab')
        pubsub.publish('topic', 'ba')
        expect(spy.callCount).to.equal(2)
    })

    test("observable receives replayed messages", function () {
        var actor = new Actor(pubsub),
            observable = actor.messages,
            spy = sinon.spy()

        observable.where(function (message) { return message[0] === 'a' }).subscribe(spy)
        actor.replay([
            { topic: 'topic', data: 'aa' },
            { topic: 'topic', data: 'ab' },
            { topic: 'topic', data: 'ba' }
        ])
        expect(spy.callCount).to.equal(2)
    })
})
