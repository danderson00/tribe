var store = require('tribe/client/eventStore')
require('../..')

suite('tribe.rx.browser.integration', function () {
    suiteSetup(function () {
        $('#template--rx-query-topic').remove()
        $('head').append('<script type="text/template" id="template--rx-query-topic"><ul data-bind="foreach: query(\'t1\')"><li /></ul></script>')
        $('#template--rx-query-both').remove()
        $('head').append('<script type="text/template" id="template--rx-query-both"><ul data-bind="foreach: query(\'t1\', { p1: 1 })"><li /></ul></script>')
    })

    test("query retrieves messages by topic", function () {
        return store.clear()
            .then(function () {
                return store.store({}, [{ topic: 't1', data: 1 }, { topic: 't1', data: 2 }, { topic: 't2', data: 3 }])
            })
            .then(function () {
                var node = T.createNode('body', { path: '/rx/query/topic' })
                return node.pane.is.rendered
            })
            .then(function () {
                expect($('li').length).to.equal(2)
            })
    })

    test("query retrieves messages by topic and scope", function () {
        return store.clear()
            .then(function () {
                return store.store({ p1: 1 }, [{ topic: 't1', data: { p1: 1 } }, { topic: 't2', data: { p1: 1 } }])
            })
            .then(function () {
                var node = T.createNode('body', { path: '/rx/query/both' })
                return node.pane.is.rendered
            })
            .then(function () {
                expect($('li').length).to.equal(1)
            })
    })

    test("queries are live", function () {
        return store.clear()
            .then(function () {
                return store.store({ p1: 1 }, [{ topic: 't1', data: { p1: 1 } }, { topic: 't2', data: { p1: 1 } }])
            })
            .then(function () {
                var node = T.createNode('body', { path: '/rx/query/both' })
                return node.pane.is.rendered.then(function () {
                    expect($('li').length).to.equal(1)
                    node.pane.pubsub.publishSync('t1', { p1: 1 })
                    node.pane.pubsub.publishSync('t1', { p1: 2 })
                    node.pane.pubsub.publishSync('t2', { p1: 1 })
                    expect($('li').length).to.equal(2)
                })
        })
    })
})
