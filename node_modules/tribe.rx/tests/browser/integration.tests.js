var uuid = require('node-uuid')

suite('tribe.rx.browser.integration', function () {
    test("text is updated on new messages", function () {
        require('../..')
        $('#template--rx-text').remove()
        $('head').append('<script type="text/template" id="template--rx-text"><span data-bind="text: messages.select(function (x) { return x.text })"></span></script>')

        var id = uuid.v4(),
            node = T.createNode('body', { path: '/rx/text', scope: { actorId: id } })

        return node.pane.is.rendered.then(function () {
            node.pane.pubsub.publish('topic', { text: 'test', actorId: id })
            expect($('span').text()).to.equal('test')
        })
    })

    test("foreach is updated on new messages", function (done) {
        require('../..')
        $('#template--rx-foreach').remove()
        $('head').append('<script type="text/template" id="template--rx-foreach"><ul data-bind="foreach: messages.where(function (x) { return x.done })"><li /></ul></script>')

        var id = uuid.v4(),
            node = T.createNode('body', { path: '/rx/foreach', scope: { actorId: id } })

        return node.pane.is.rendered.then(function () {
            node.pane.pubsub.publish('topic', { done: true, actorId: id })
            node.pane.pubsub.publish('topic', { done: true, actorId: id })
            node.pane.pubsub.publish('topic', { actorId: id })
            expect($('ul').children().length).to.equal(2)
        })
    })

    test("topic filters messages by topic", function (done) {
        require('../..')
        $('#template--rx-foreach').remove()
        $('head').append('<script type="text/template" id="template--rx-foreach"><ul data-bind="foreach: topic(\'a\')"><li /></ul></script>')

        var id = uuid.v4(),
            node = T.createNode('body', { path: '/rx/foreach', scope: { actorId: id } })

        return node.pane.is.rendered.then(function () {
            node.pane.pubsub.publish('a')
            node.pane.pubsub.publish('a')
            node.pane.pubsub.publish('b')
            expect($('ul').children().length).to.equal(2)
        })
    })
})
