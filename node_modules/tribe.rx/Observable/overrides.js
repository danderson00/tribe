var Rx = require('rx')

Rx.Observable.prototype.count = function (predicate) {
    return createObservable(this, 0, function () {
        var count = 0

        return function (value) {
            if(!predicate || predicate.apply(this, arguments))
                return ++count
        }
    })
}

Rx.Observable.prototype.sum = function (predicate) {
    return createObservable(this, 0, function () {
        var sum = 0

        return function (value) {
            var valueToAdd = predicate ? predicate.apply(this, arguments) : value
            if(valueToAdd)
                return sum += valueToAdd
        }
    })
}


function createObservable(source, initialValue, valueResolverFactory) {
    return Rx.Observable.create(function (observer) {
        var valueResolver = valueResolverFactory()

        source.subscribe(
            function () {
                var nextValue = valueResolver.apply(this, arguments)
                if(nextValue)
                    observer.onNext(nextValue)
            },
            function () { observer.onError.apply(observer, arguments) },
            function () { observer.onCompleted.apply(observer, arguments) }
        )

        if(initialValue !== undefined)
            observer.onNext(initialValue)
    })
}
