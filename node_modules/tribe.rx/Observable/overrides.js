var Rx = require('rx')

Rx.Observable.prototype.count = function (predicate, initialValue) {
    return createObservable(this, initialValue || 0, function () {
        var count = initialValue || 0

        return function (value) {
            if(!predicate || predicate.apply(this, arguments))
                return ++count
        }
    })
}

Rx.Observable.prototype.sum = function (predicate, initialValue) {
    return createObservable(this, initialValue || 0, function () {
        var sum = initialValue || 0

        return function (value) {
            var valueToAdd = predicate ? predicate.apply(this, arguments) : value
            if(valueToAdd)
                return sum += valueToAdd
        }
    })
}

Rx.Observable.prototype.average = function (predicate) {
    return createObservable(this, undefined, function () {
        var count = 0,
            total = 0

        return function (value) {
            if(predicate) value = predicate.apply(this, arguments)
            count++
            total += value
            return total / count
        }
    })
} 

function createObservable(source, initialValue, valueResolverFactory) {
    return Rx.Observable.create(function (observer) {
        var valueResolver = valueResolverFactory()

        source.subscribe(
            function (value) {
                var nextValue = valueResolver ? valueResolver.apply(this, arguments) : value
                if(nextValue !== undefined)
                    observer.onNext(nextValue)
            },
            function () { observer.onError.apply(observer, arguments) },
            function () { observer.onCompleted.apply(observer, arguments) }
        )

        if(initialValue !== undefined)
            observer.onNext(initialValue)
    })
}
