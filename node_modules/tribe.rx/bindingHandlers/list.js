// purely sugar to automatically call asArray on Rx observables
var oldBinding = ko.bindingHandlers.foreach,
    domDataKey = '__tribe_rx__foreachDomDataKey__'

ko.bindingHandlers.foreach = {
    init: function(element, valueAccessor) {
        var value = valueAccessor()
        if(value && value.asArray) {
            value = value.asArray()
            ko.utils.domData.set(element, domDataKey, value)
        }
        return oldBinding.init(element, function() { return value })
    },
    update: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        return oldBinding.update(element, function () {
            var storedObservable = ko.utils.domData.get(element, domDataKey)
            return storedObservable ? storedObservable() : valueAccessor()
        }, allBindingsAccessor, viewModel, bindingContext);
    },
    makeTemplateValueAccessor: oldBinding.makeTemplateValueAccessor
}
