var query = require('../query'),
    actor = require('tribe.pubsub/actor'),
    log = require('tribe.logger'),
    getArguments = require('tribe/utilities/arguments')

T.Events.addRxToModel = function (pane, context) {
    if(!pane.model.hasOwnProperty('messages')) {
        pane.model.__defineGetter__('messages', function () {
            return paneActor().messages
        })
    }

    if(!pane.model.hasOwnProperty('envelopes')) {
        pane.model.__defineGetter__('envelopes', function () {
            return paneActor().envelopes
        })
    }

    if(!pane.model.topic) {
        pane.model.topic = function (topic) {
            return paneActor().envelopes
                .topic(topic)
                .select(function (x) { return x.data })
        }
    }

    if(!pane.model.query) {
        pane.model.query = function (scopeOrTopic) {
            var args = getArguments(arguments),
                topic = args.string,
                scope = args.object

            return query(pane, context, topic, scope)
        }
    }

    function paneActor() {
        if(!pane.__generatedActor) {
            pane.__generatedActor = new actor(pane.pubsub, constructor)
            // this blocks renderComplete until completed
            context.renderOperation.add(pane.__generatedActor)
        }
        return pane.__generatedActor

        function constructor(actor) {
            actor.isDistributed && actor.isDistributed()
        }
    }
}
