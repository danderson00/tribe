window.Tribe=window.Tribe||{},Tribe.PubSub=function(n){function f(n){function o(t){var i=u("exceptionHandler");if(u("handleExceptions"))try{t(n.data,n)}catch(r){i&&i(r,n)}else t(n.data,n)}for(var f=t.get(n.topic),s=n.sync===!0||i.sync===!0,r=0,e=f.length;r<e;r++)s?o(f[r].handler):function(n){setTimeout(function(){o(n.handler)})}(f[r])}function u(t){return n&&n.hasOwnProperty(t)?n[t]:Tribe.PubSub.options[t]}var i=this,r=Tribe.PubSub.utils,t;this.owner=this,this.sync=u("sync"),t=new Tribe.PubSub.SubscriberList,this.subscribers=t,this.publish=function(n,t){var i=n&&n.topic?n:{topic:n,data:t,sync:!1};return f(i)},this.publishSync=function(n,t){return f({topic:n,data:t,sync:!0})},this.subscribe=function(n,i){return typeof n=="string"?t.add(n,i):r.isArray(n)?r.map(n,function(n){return t.add(n,i)}):r.map(n,function(n,i){return t.add(i,n)})},this.unsubscribe=function(n){var r,i,u;if(Tribe.PubSub.utils.isArray(n)){for(r=[],i=0,u=n.length;i<u;i++)r.push(t.remove(n[i]));return r}return t.remove(n)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(i,i)}},Tribe.PubSub.Lifetime=function(n,t){function u(n){return Tribe.PubSub.utils.isArray(n)?i=i.concat(n):i.push(n),n}var r=this,i=[];this.owner=t,this.publish=function(t,i){return n.publish(t,i)},this.publishSync=function(t,i){return n.publishSync(t,i)},this.subscribe=function(t,i){var r=n.subscribe(t,i);return u(r)},this.subscribeOnce=function(t,i){var r=n.subscribeOnce(t,i);return u(r)},this.unsubscribe=function(t){return n.unsubscribe(t)},this.end=function(){return n.unsubscribe(i)},this.createLifetime=function(){return new Tribe.PubSub.Lifetime(r,r.owner)}},window.Tribe.PubSub.options={sync:!1,handleExceptions:!0,exceptionHandler:function(n,t){console.log("Exception occurred in subscriber to '"+t.topic+"': "+n.message)}},Tribe.PubSub.Saga=function(n,t){function o(t,i){i!=="onstart"&&i!=="onend"&&(t?t.constructor===Function?n.subscribe(i,s(t)):n.subscribe(i,h(t)):n.subscribe(i,c()))}function s(n){return function(r,u){t.endsChildrenExplicitly||f(r),n(r,u,i)}}function h(n){return function(t){i.startChild({handles:n},t)}}function c(){return function(n){i.end(n)}}function f(n){Tribe.PubSub.utils.each(i.children,function(t){t.end(n)})}function e(n,t){if(n.constructor===Function){var r=[i].concat(t);n=u.applyToConstructor(n,r)}return n}var i=this,u=Tribe.PubSub.utils,r;n=n.createLifetime(),this.pubsub=n,this.children=[],t=e(t,Array.prototype.slice.call(arguments,2)),r=t.handles||{},this.start=function(n){if(u.each(r,o),r.onstart)r.onstart(n,i);return i},this.startChild=function(t){return i.children.push(new Tribe.PubSub.Saga(n,e(t,Array.prototype.slice.call(arguments,1))).start()),i},this.end=function(t){if(r.onend)r.onend(t,i);return n.end(),f(t),i}},Tribe.PubSub.Saga.startSaga=function(n){var t=[this,n].concat(Array.prototype.slice.call(arguments,1)),i=Tribe.PubSub.utils.applyToConstructor(Tribe.PubSub.Saga,t);return i.start()},Tribe.PubSub.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.Lifetime.prototype.startSaga=Tribe.PubSub.Saga.startSaga,Tribe.PubSub.prototype.subscribeOnce=function(n,t){function e(){var i={};return r.each(n,function(n){i[n]=u(t)}),i}function o(){return r.map(n,function(n,t){return i.subscribe(t,u(n))})}function u(n){return function(){i.end(),n.apply(f,arguments)}}var f=this,r=Tribe.PubSub.utils,i=this.createLifetime();return typeof n=="string"?i.subscribe(n,u(t)):r.isArray(n)?i.subscribe(e()):i.subscribe(o())},Tribe.PubSub.SubscriberList=function(){function i(n,t){if(t==="*")return!0;var i="^"+t.replace(/\./g,"\\.").replace(/\*/g,"[^.]*")+"$";return n.match(i)}var n={},t=-1;this.get=function(t){var u=[],r;for(r in n)n.hasOwnProperty(r)&&i(t,r)&&(u=u.concat(n[r]));return u},this.add=function(i,r){var u=(++t).toString();return n.hasOwnProperty(i)||(n[i]=[]),n[i].push({topic:i,handler:r,token:u}),u},this.remove=function(t){var i,r,u;for(i in n)if(n.hasOwnProperty(i))for(r=0,u=n[i].length;r<u;r++)if(n[i][r].token===t)return n[i].splice(r,1),t;return!1}},Tribe.PubSub.utils={},function(n){n.isArray=function(n){return n.constructor===Array},n.applyToConstructor=function(n,t){var i=[null].concat(t),r=n.bind.apply(n,i);return new r};var t=Array.prototype.forEach,i=Array.prototype.map,r={};n.each=function(n,i,u){var f,o,e;if(n!=null)if(t&&n.forEach===t)n.forEach(i,u);else if(n.length===+n.length){for(f=0,o=n.length;f<o;f++)if(i.call(u,n[f],f,n)===r)return}else for(e in n)if(n.hasOwnProperty(e)&&i.call(u,n[e],e,n)===r)return},n.map=function(t,r,u){var f=[];return t==null?f:i&&t.map===i?t.map(r,u):(n.each(t,function(n,t,i){f[f.length]=r.call(u,n,t,i)}),f)}}(Tribe.PubSub.utils);